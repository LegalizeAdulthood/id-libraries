
Raytrace2 {
global:
  int xx=#width+1
  int yy=#height+1
  int zz=@zpixels-1
  float arr[#width+1,#height+1]
  int arr2[#width+1,#height+1]
  int zarr_real[#width+1,#height+1]
  int zarr_imag[#width+1,#height+1]
  bool flag=false
  int counter=0
  complex temp=0
  int i=0
  int m=0
  int n=0
  int t=0
  int tt=0
  complex zri=0
  complex zjk=0
  complex zlm=0
  complex cri=0
  complex cjk=0
  temp=0
  float zr =0
  float zi =0
  float zj=0
  float zk=0
  float xmin=0
  float ymin=0
  float zmin=0
  float xmax=0
  float ymax=0
  float zmax=0
  float xtot=0
  float ytot=0
  float ztot=0
  float vrot=0
  float cosx=0
  float sinx=0
  float cosy=0
  float siny=0
  float cosz=0
  float sinz=0
  float dx=0
  float dy=0
  float dz=0
  float dxx=0
  float dxy=0
  float dxz=0
  float dyx=0
  float dyy=0
  float dyz=0
  float dzx=0
  float dzy=0
  float dzz=0
  float dzx1=0
  float dzy1=0
  float dzz1=0
  float rxmin=0
  float rymin=0
  float rzmin=0
  float tempx=0
  float tempy=0
  float tempz=0
  float rx=0
  float ry=0
  float rz=0
  
  if xx/yy>4/3
    xtot=-3/#magn
    ytot=xtot
    ymin=imag(#center)-ytot/2
    ymax=ymin+ytot
    xtot=-xx/yy*xtot
    xmin=real(#center)-xtot/2
    xmax=xmin+xtot
  else
    xtot=4/#magn
    xmin=real(#center)-xtot/2
    xmax=xmin+xtot
    ytot=-yy/xx*xtot
    ymin=imag(#center)-ytot/2
    ymax=ymin+ytot
  endif
  ztot=@zlength
  zmin=@zcenter-ztot/2
  zmax=zmin+ztot
  if @view==true
    zz=1
    zmin=@zcenter
    zmax=zmin
  endif
  dx=(xmax-xmin)/xx
  dy=(ymax-ymin)/yy
  dz=(zmax-zmin)/zz
  
  vrot=@xrot/180*#pi
  cosx=cos(vrot)
  sinx=sin(vrot)
  vrot=@yrot/180*#pi
  cosy=cos(vrot)
  siny=sin(vrot)
  vrot=-@zrot/180*#pi
  cosz=cos(vrot)
  sinz=sin(vrot)
  
  rx=xmin
  ry=ymin
  rz=zmin
  if @localrot
    rx=rx-real(#center)
    ry=ry-imag(#center)
    rz=rz-@zcenter
  endif
  tempy=ry*cosx-rz*sinx
  tempz=ry*sinx+rz*cosx
  tempx=rx
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosy+rz*siny
  tempz=-rx*siny+rz*cosy
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosz-ry*sinz
  tempy=rx*sinz+ry*cosz
  rx=tempx
  ry=tempy
  rz=tempz
  if @localrot
    rx=rx+real(#center)
    ry=ry+imag(#center)
    rz=rz+@zcenter
  endif
  
  rxmin=rx
  rymin=ry
  rzmin=rz
  
  rx=xmax
  ry=ymin
  rz=zmin
  if @localrot
    rx=rx-real(#center)
    ry=ry-imag(#center)
    rz=rz-@zcenter
  endif
  tempy=ry*cosx-rz*sinx
  tempz=ry*sinx+rz*cosx
  tempx=rx
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosy+rz*siny
  tempz=-rx*siny+rz*cosy
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosz-ry*sinz
  tempy=rx*sinz+ry*cosz
  rx=tempx
  ry=tempy
  rz=tempz
  
  if @localrot
    rx=rx+real(#center)
    ry=ry+imag(#center)
    rz=rz+@zcenter
  endif

  dxx=(rx-rxmin)/xx
  dxy=(ry-rymin)/xx
  dxz=(rz-rzmin)/xx
  
  rx=xmin
  ry=ymax
  rz=zmin
  if @localrot
    rx=rx-real(#center)
    ry=ry-imag(#center)
    rz=rz-@zcenter
  endif
  tempy=ry*cosx-rz*sinx
  tempz=ry*sinx+rz*cosx
  tempx=rx
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosy+rz*siny
  tempz=-rx*siny+rz*cosy
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosz-ry*sinz
  tempy=rx*sinz+ry*cosz
  rx=tempx
  ry=tempy
  rz=tempz
  
  if @localrot
    rx=rx+real(#center)
    ry=ry+imag(#center)
    rz=rz+@zcenter
  endif

  dyx=(rx-rxmin)/yy
  dyy=(ry-rymin)/yy
  dyz=(rz-rzmin)/yy
  
  rx=xmin
  ry=ymin
  rz=zmax
  if @localrot
    rx=rx-real(#center)
    ry=ry-imag(#center)
    rz=rz-@zcenter
  endif
  tempy=ry*cosx-rz*sinx
  tempz=ry*sinx+rz*cosx
  tempx=rx
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosy+rz*siny
  tempz=-rx*siny+rz*cosy
  rx=tempx
  ry=tempy
  rz=tempz
  
  tempx=rx*cosz-ry*sinz
  tempy=rx*sinz+ry*cosz
  rx=tempx
  ry=tempy
  rz=tempz
  
  if @localrot
    rx=rx+real(#center)
    ry=ry+imag(#center)
    rz=rz+@zcenter
  endif

  dzx=(rx-rxmin)/zz
  dzy=(ry-rymin)/zz
  dzz=(rz-rzmin)/zz
  dzx1=dzx/@precision


  dzy1=dzy/@precision
  dzz1=dzz/@precision
  
  if @Formula==0      ;Quaternion
    cri=@cri1
    cjk=@cjk1  
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            repeat
                temp=zri*zri-real(zjk)^2-imag(zjk)^2+cri
                zjk=2*(real(zri)*real(zjk)+flip(real(zri)*imag(zjk)))+cjk
                zri=temp
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter|||zri|+|zjk|>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Fourth_Dimension==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
              elseif @Fourth_Dimension==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)
              elseif @Fourth_Dimension==2
                zri=zj+flip(zk)
                zjk=zr+flip(zi)
              else
                zri=zk+flip(zj)
                zjk=zr+flip(zi)
              endif
              repeat
                  temp=zri*zri-real(zjk)^2-imag(zjk)^2+cri
                  zjk=2*(real(zri)*real(zjk)+flip(real(zri)*imag(zjk)))+cjk
                  zri=temp
                  i=i+1
              until  i>=@maxiter|||zri|+|zjk|>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
  elseif @Formula==1   ;Hypernion
    cri=@cri1
    cjk=@cjk1  
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            repeat
                temp=zri*zri-real(zjk)^2+imag(zjk)^2-2*flip(real(zjk)*imag(zjk))+cri
                zjk=2*(real(zri)*real(zjk)-imag(zri)*imag(zjk)+flip(real(zri)*imag(zjk)+imag(zri)*real(zjk)))+cjk
                zri=temp
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter|||zri|+|zjk|>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Fourth_Dimension==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
              elseif @Fourth_Dimension==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)
              elseif @Fourth_Dimension==2
                zri=zj+flip(zk)
                zjk=zr+flip(zi)
              else
                zri=zk+flip(zj)
                zjk=zr+flip(zi)
              endif
              repeat
                temp=zri*zri-real(zjk)^2+imag(zjk)^2-2*flip(real(zjk)*imag(zjk))+cri
                zjk=2*(real(zri)*real(zjk)-imag(zri)*imag(zjk)+flip(real(zri)*imag(zjk)+imag(zri)*real(zjk)))+cjk
                zri=temp
                i=i+1
              until  i>=@maxiter|||zri|+|zjk|>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2


          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile

  elseif @Formula==2    ;Quaternion 2
    cri=@cri2
    cjk=@cjk2
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(zri)
            float b=imag(zri)
            float c=real(zjk)
            float d=imag(zjk)
            float ee=real(cri)
            float f=imag(cri)
            float g=real(cjk)
            float h=imag(cjk)
            float length=0
            repeat
                float q=a-(a*a-b*b-c*c-d*d)
                float r=1-2*a
                float l=-f*b-g*c-h*d
                float u=ee*b+g*d-h*c
                float v=ee*c+h*b-f*d
                float w=ee*d+f*c-g*b
                a=ee*q+l*r
                b=f*q+u*r
                c=g*q+v*r
                d=h*q+w*r 
                length=a*a+b*b+c*c+d*d
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until i>=@maxiter||length>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
              float a=real(zri)
              float b=imag(zri)
              float c=real(zjk)
              float d=imag(zjk)
              float ee=real(cri)
              float f=imag(cri)
              float g=real(cjk)
              float h=imag(cjk)
              float length=0
              repeat
                q=a-(a*a-b*b-c*c-d*d)
                r=1-2*a
                l=-f*b-g*c-h*d
                u=ee*b+g*d-h*c
                v=ee*c+h*b-f*d
                w=ee*d+f*c-g*b
                a=ee*q+l*r
                b=f*q+u*r
                c=g*q+v*r
                d=h*q+w*r 
                length=a*a+b*b+c*c+d*d
                i=i+1
              until  i>=@maxiter||length>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1        
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile

      m=m+1
    endwhile
    
  elseif @Formula==3   ;Hypernion 2
    cri=@cri2
    cjk=@cjk2
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(zri)
            float b=imag(zri)
            float c=real(zjk)
            float d=imag(zjk)
            float ee=real(cri)
            float f=imag(cri)
            float g=real(cjk)
            float h=imag(cjk)
            float length=0
            float a1=0
            float b1=0
            float c1=0
            float d1=0
            repeat
              float q=a*a-b*b-c*c+d*d
              float u=c*d-a*b
              float v=b*d-a*c
              float w=a*d+b*c
              a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))

              b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
              c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
              d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
              a=a1
              b=b1
              c=c1
              d=d1
              length=a*a+b*b+c*c+d*d
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter||length>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif

              float a=real(zri)
              float b=imag(zri)
              float c=real(zjk)
              float d=imag(zjk)
              float ee=real(cri)
              float f=imag(cri)
              float g=real(cjk)
              float h=imag(cjk)
              float a1=0
              float b1=0
              float c1=0
              float d1=0
              float length=0
              repeat
                  float q=a*a-b*b-c*c+d*d
                  float u=c*d-a*b
                  float v=b*d-a*c
                  float w=a*d+b*c
                  a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))
                  b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
                  c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
                  d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
                  a=a1
                  b=b1
                  c=c1
                  d=d1
                  length=a*a+b*b+c*c+d*d
                i=i+1
              until  i>=@maxiter||length>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1        
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
    
  elseif @Formula==4   ;Cubic Quaternion
    cri=@cri3
    cjk=@cjk3
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(zri)
            float b=imag(zri)
            float c=real(zjk)
            float d=imag(zjk)
            float ee=real(cri)
            float f=imag(cri)
            float g=real(cjk)
            float h=imag(cjk)
            float ii=real(@bri)
            float j=imag(@bri)
            float k=real(@bjk)
            float l=imag(@bjk)
            float length=0
            repeat
                float u=3*a*a-b*b-c*c-d*d
                float v=3*(ee*ee-f*f-g*g-h*h)
                float w=6*ee
                float q=u-v
                float a1=a*(3*u-8*a*a-v)+w*(f*b+g*c+h*d)+ii
                float b1=b*q-w*(f*a+g*d-h*c)+j
                float c1=c*q-w*(-f*d+g*a+h*b)+k
                float d1=d*q-w*(f*c-g*b+h*a)+l
                a=a1


                b=b1
                c=c1
                d=d1 
                length=a*a+b*b+c*c+d*d
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter||length>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(zri)
            float b=imag(zri)
            float c=real(zjk)
            float d=imag(zjk)
            float ee=real(cri)
            float f=imag(cri)
            float g=real(cjk)
            float h=imag(cjk)
            float ii=real(@bri)
            float j=imag(@bri)
            float k=real(@bjk)
            float l=imag(@bjk)
            float length=0
            repeat
                float u=3*a*a-b*b-c*c-d*d
                float v=3*(ee*ee-f*f-g*g-h*h)
                float w=6*ee
                float q=u-v
                float a1=a*(3*u-8*a*a-v)+w*(f*b+g*c+h*d)+ii
                float b1=b*q-w*(f*a+g*d-h*c)+j
                float c1=c*q-w*(-f*d+g*a+h*b)+k
                float d1=d*q-w*(f*c-g*b+h*a)+l
                a=a1
                b=b1
                c=c1
                d=d1 
                length=a*a+b*b+c*c+d*d
                i=i+1
            until  i>=@maxiter||length>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1        
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
    

  elseif @Formula==5   ;Cubic Hypernion
    cri=@cri3
    cjk=@cjk3
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(zri)
            float b=imag(zri)
            float c=real(zjk)
            float d=imag(zjk)
            float ee=real(cri)
            float f=imag(cri)
            float g=real(cjk)
            float h=imag(cjk)
            float ii=real(@bri)
            float j=imag(@bri)
            float k=real(@bjk)
            float l=imag(@bjk)

            float length=0
            repeat
                float r5=a*a
                float r6=b*b
                float r7=c*c
                float r8=d*d
                float u=ee*ee-f*f-g*g+h*h
                float v=g*h-ee*f
                float w=f*h-ee*g
                float q=ee*h+f*g
                float r=-r7+r8
                float r2=r5-r6
                float r3=6*c*d
                float r4=6*a*b
                float a1=r5*a+3*a*(-r6+r)+b*r3-3*(a*u+2*(b*v+c*w+d*q))+ii

                float b1=-r6*b+3*b*(r5+r)-a*r3-3*(b*u+2*(-a*v+d*w-c*q))+j
                float c1=-r7*c+3*c*(r2+r8)-r4*d-3*(c*u+2*(d*v-a*w-b*q))+k
                float d1=r8*d+3*d*(r2-r7)+r4*c-3*(d*u+2*(-c*v-b*w+a*q))+l
                a=a1
                b=b1
                c=c1
                d=d1 
                length=a*a+b*b+c*c+d*d
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter||length>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
            if @Fourth_Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(zri)
            float b=imag(zri)
            float c=real(zjk)
            float d=imag(zjk)
            float ee=real(cri)
            float f=imag(cri)
            float g=real(cjk)
            float h=imag(cjk)
            float ii=real(@bri)
            float j=imag(@bri)
            float k=real(@bjk)

            float l=imag(@bjk)
            float length=0
           repeat
                float r5=a*a
                float r6=b*b
                float r7=c*c
                float r8=d*d
                float u=ee*ee-f*f-g*g+h*h
                float v=g*h-ee*f
                float w=f*h-ee*g

                float q=ee*h+f*g
                float r=-r7+r8
                float r2=r5-r6
                float r3=6*c*d
                float r4=6*a*b
                float a1=r5*a+3*a*(-r6+r)+b*r3-3*(a*u+2*(b*v+c*w+d*q))+ii
                float b1=-r6*b+3*b*(r5+r)-a*r3-3*(b*u+2*(-a*v+d*w-c*q))+j
                float c1=-r7*c+3*c*(r2+r8)-r4*d-3*(c*u+2*(d*v-a*w-b*q))+k
                float d1=r8*d+3*d*(r2-r7)+r4*c-3*(d*u+2*(-c*v-b*w+a*q))+l
                a=a1
                b=b1
                c=c1

                d=d1 
                length=a*a+b*b+c*c+d*d
                i=i+1
              until  i>=@maxiter||length>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1        
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
    
  elseif @Formula==6      ;Quatbrot  
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx

        t=0
        zr=rxmin+n*dxx+m*dyx

        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth__Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth__Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth__Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            complex cri=zri
            complex cjk=zjk
            zri=@init_zri
            zjk=@init_zjk
            repeat
                temp=zri*zri-real(zjk)^2-imag(zjk)^2+cri
                zjk=2*(real(zri)*real(zjk)+flip(real(zri)*imag(zjk)))+cjk
                zri=temp
                i=i+1
                if i==@maxiter
                  flag=true

                endif
            until  i>=@maxiter|||zri|+|zjk|>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Fourth__Dim==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
              elseif @Fourth__Dim==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)
              elseif @Fourth__Dim==2
                zri=zj+flip(zk)
                zjk=zr+flip(zi)
              else
                zri=zk+flip(zj)
                zjk=zr+flip(zi)
              endif
              complex cri=zri
              complex cjk=zjk
              zri=@init_zri
              zjk=@init_zjk
              repeat
                  temp=zri*zri-real(zjk)^2-imag(zjk)^2+cri
                  zjk=2*(real(zri)*real(zjk)+flip(real(zri)*imag(zjk)))+cjk

                  zri=temp
                  i=i+1
              until  i>=@maxiter|||zri|+|zjk|>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)

        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    

  elseif @Formula==7   ;Hyperbrot  
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth__Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth__Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth__Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            complex cri=zri
            complex cjk=zjk
            zri=@init_zri
            zjk=@init_zjk
            repeat
                temp=zri*zri-real(zjk)^2+imag(zjk)^2-2*flip(real(zjk)*imag(zjk))+cri

                zjk=2*(real(zri)*real(zjk)-imag(zri)*imag(zjk)+flip(real(zri)*imag(zjk)+imag(zri)*real(zjk)))+cjk
                zri=temp
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter|||zri|+|zjk|>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Fourth__Dim==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
              elseif @Fourth__Dim==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)
              elseif @Fourth__Dim==2
                zri=zj+flip(zk)
                zjk=zr+flip(zi)
              else
                zri=zk+flip(zj)
                zjk=zr+flip(zi)
              endif
              complex cri=zri
              complex cjk=zjk
              zri=@init_zri
              zjk=@init_zjk
              repeat
                temp=zri*zri-real(zjk)^2+imag(zjk)^2-2*flip(real(zjk)*imag(zjk))+cri
                zjk=2*(real(zri)*real(zjk)-imag(zri)*imag(zjk)+flip(real(zri)*imag(zjk)+imag(zri)*real(zjk)))+cjk
                zri=temp
                i=i+1
              until  i>=@maxiter|||zri|+|zjk|>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz

          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
    
  elseif @Formula==8    ;Quatbrot2
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy

            zj=zj+dzz
            if @Fourth__Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth__Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth__Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(@init__zri)
            float b=imag(@init__zri)
            float c=real(@init__zjk)
            float d=imag(@init__zjk)
            float ee=real(zri)
            float f=imag(zri)
            float g=real(zjk)
            float h=imag(zjk)
            float length=0
            repeat
                float q=a-(a*a-b*b-c*c-d*d)
                float r=1-2*a
                float l=-f*b-g*c-h*d
                float u=ee*b+g*d-h*c
                float v=ee*c+h*b-f*d
                float w=ee*d+f*c-g*b
                a=ee*q+l*r
                b=f*q+u*r
                c=g*q+v*r
                d=h*q+w*r 
                length=a*a+b*b+c*c+d*d
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter||length>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile

        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
            if @Fourth__Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth__Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth__Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
              float a=real(@init__zri)
              float b=imag(@init__zri)
              float c=real(@init__zjk)
              float d=imag(@init__zjk)
              float ee=real(zri)
              float f=imag(zri)
              float g=real(zjk)
              float h=imag(zjk)
              float length=0
              repeat
                q=a-(a*a-b*b-c*c-d*d)
                r=1-2*a
                l=-f*b-g*c-h*d
                u=ee*b+g*d-h*c
                v=ee*c+h*b-f*d
                w=ee*d+f*c-g*b
                a=ee*q+l*r
                b=f*q+u*r
                c=g*q+v*r
                d=h*q+w*r 
                length=a*a+b*b+c*c+d*d
                i=i+1
              until  i>=@maxiter||length>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1        
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0


            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
  elseif @Formula==9   ;Hyperbrot 2
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth__Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth__Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth__Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            float a=real(@init__zri)
            float b=imag(@init__zri)
            float c=real(@init__zjk)
            float d=imag(@init__zjk)
            float ee=real(zri)
            float f=imag(zri)
            float g=real(zjk)
            float h=imag(zjk)
            float length=0
            float a1=0
            float b1=0
            float c1=0
            float d1=0
            repeat
              float q=a*a-b*b-c*c+d*d
              float u=c*d-a*b
              float v=b*d-a*c
              float w=a*d+b*c
              a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))
              b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
              c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
              d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
              a=a1
              b=b1
              c=c1
              d=d1
              length=a*a+b*b+c*c+d*d
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter||length>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
            if @Fourth__Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth__Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth__Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
              float a=real(@init__zri)
              float b=imag(@init__zri)
              float c=real(@init__zjk)
              float d=imag(@init__zjk)
              float ee=real(zri)
              float f=imag(zri)
              float g=real(zjk)
              float h=imag(zjk)
              float a1=0
              float b1=0
              float c1=0
              float d1=0
              float length=0
              repeat
                  float q=a*a-b*b-c*c+d*d
                  float u=c*d-a*b
                  float v=b*d-a*c
                  float w=a*d+b*c
                  a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))
                  b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
                  c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
                  d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
                  a=a1
                  b=b1
                  c=c1
                  d=d1
                  length=a*a+b*b+c*c+d*d
                i=i+1
              until  i>=@maxiter||length>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1        
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile

  
  elseif @Formula==10    ;Juliabrot

    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            repeat
                zri=zri^2+zjk
                i=i+1
                if i==@maxiter
                  flag=true
                endif
            until  i>=@maxiter|||zri|>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Fourth_Dim==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
              elseif @Fourth_Dim==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)

              elseif @Fourth_Dim==2
                zri=zj+flip(zk)
                zjk=zr+flip(zi)
              else
                zri=zk+flip(zj)
                zjk=zr+flip(zi)
              endif
              repeat
                zri=zri^2+zjk
                i=i+1
              until  i>=@maxiter|||zri|>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
  elseif @Formula==11   ;Juliabrot 2
    zk=@fourthdim
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            i=0
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth_Dim==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth_Dim==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth_Dim==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif

            repeat

                zri=zjk*zri*(1-zri)

                i=i+1
                if i==@maxiter
                  flag=true
                endif
           until  i>=@maxiter|||zri|>@bailout
            t=t+1
            if @view==true
              arr[n,m]=i
            endif
        endwhile
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Fourth_Dim==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
              elseif @Fourth_Dim==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)
              elseif @Fourth_Dim==2
                zri=zj+flip(zk)
                zjk=zr+flip(zi)
              else
                zri=zk+flip(zj)
                zjk=zr+flip(zi)
              endif
              repeat
                zri=zjk*zri*(1-zri)
                i=i+1
              until  i>=@maxiter|||zri|>@bailout
              tt=tt+1
              if i<@maxiter
                flag=false
              endif
          endwhile
          tt=tt-1
        endif
        zarr_real[n,m]=round(real(zri)*1000)
        zarr_imag[n,m]=round(imag(zri)*1000)
        if t<zz&&@view==false
          arr[n,m]=zmin+t*dz-tt*dz/@precision
          if arr[n,m]==zmin&&@touchscreen==true
            arr2[n,m]=5
         elseif @Gradient==0
            arr2[n,m]=1
          else
            arr2[n,m]=3
          endif
        elseif @view==false
          arr[n,m]=zmax+dz
          if @Background==0
            arr2[n,m]=0
          elseif @Background==2
            arr2[n,m]=5
          elseif @Gradient==0
            arr2[n,m]=6
          else
            arr2[n,m]=2
          endif
        else
          arr2[n,m]=4
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
  elseif @Formula==12   ;Cubic Parameterspace
    complex cz=0
    complex setstore=0
    complex zstore=0
    complex zstore1=0
    complex zstore2=0
    float zstoren1=0
    float zstoren2=0
    int istore1=0
    int istore2=0
    bool flagstore1=false
    bool flagstore2=false
    zk=@fourthdim
    m=0
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Fourth__Dimension==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
            elseif @Fourth__Dimension==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
            elseif @Fourth__Dimension==2
              zri=zj+flip(zk)
              zjk=zr+flip(zi)
            else
              zri=zk+flip(zj)
              zjk=zr+flip(zi)
            endif
            counter=0
            repeat
              i=0
              if @MSet<2
                counter=counter+1
                if counter==1
                  cz=zri
                else
                  cz=-zri
                endif
              elseif @MSet==2
                cz=zri
              else
                cz=-zri
              endif
              repeat
                  cz=cz*cz*cz-3*zri*zri*cz+zjk
                  i=i+1
                  if i==@maxiter
                    flag=true
                  endif
             until  i>=@maxiter|||cz|>@bailout

              if @MSet>1
                zstore=cz
                counter=2
                if @view==false
                  if flag==true
                    if @Cubic_Gradient==0
                      arr2[n,m]=1
                    elseif @Cubic_Gradient==1&&(@Background==0||@Background==2)
                      if @MSet==2
                        arr2[n,m]=2
                      else
                        arr2[n,m]=3
                      endif
                    elseif @Cubic_Gradient==1
                      arr2[n,m]=3
                    elseif @Cubic_Gradient==2
                      if @MSet==2
                        arr2[n,m]=8
                      else
                        arr2[n,m]=9
                      endif
                    elseif @Cubic_Gradient==3
                      if @MSet==2
                        arr2[n,m]=12
                      else
                        arr2[n,m]=13
                      endif
                    endif
                  endif
                endif
              elseif counter==1
                istore1=i
                zstore1=cz
                zstoren1=|cz|
                flagstore1=flag
                flag=false
              elseif counter==2
                istore2=i
                zstore2=cz
                zstoren2=|cz|
                flagstore2=flag
                flag=false
                if @MSet==0
                  if @view==true
                    arr2[n,m]=4
                    if flagstore1==true||flagstore2==true
                      if flagstore1==true&&flagstore2==true
                        if zstoren1<zstoren2
                          zstore=zstoren1
                          arr[n,m]=istore1
                        else
                          zstore=zstoren2
                          arr[n,m]=istore2
                        endif
                      elseif flagstore1==true
                        zstore=zstoren1
                        arr[n,m]=istore1
                      else
                        zstore=zstoren2
                        arr[n,m]=istore2
                      endif
                    else
                      if istore1>istore2
                        arr[n,m]=istore1
                        zstore=zstore1
                      else
                        arr[n,m]=istore2
                         zstore=zstore2
                      endif
                    endif
                  elseif flagstore1==true||flagstore2==true  ;not view
                    flag=true
                    if flagstore1==true&&flagstore2==true  ;Both
                      if zstoren2<zstoren1
                        setstore=-zri
                        if @Cubic_Gradient==1
                          arr2[n,m]=3
                        elseif @Cubic_Gradient==0
                          arr2[n,m]=1
                        elseif @Cubic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=7
                        elseif @Cubic_Gradient==2&&@Background==1
                          arr2[n,m]=9
                        elseif @Cubic_Gradient==3
                          arr2[n,m]=11
                        endif
                      else
                        setstore=zri
                        if @Cubic_Gradient==1&&(@Background==0||@Background==2)
                          arr2[n,m]=2
                        elseif @Cubic_Gradient==1
                          arr2[n,m]=3
                        elseif @Cubic_Gradient==0
                          arr2[n,m]=1
                        elseif @Cubic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=7
                        elseif @Cubic_Gradient==2&&@Background==1
                          arr2[n,m]=8
                        elseif @Cubic_Gradient==3
                          arr2[n,m]=11
                        endif
                      endif
                    elseif flagstore2==true ;-MSet
                      setstore=-zri
                      if @Cubic_Gradient==1
                        arr2[n,m]=3
                      elseif @Cubic_Gradient==0
                        arr2[n,m]=1
                      elseif @Cubic_Gradient==2
                        arr2[n,m]=9
                      elseif @Cubic_Gradient==3
                        arr2[n,m]=13
                      endif
                    elseif flagstore1==true
                      arr2[n,m]=2 ;+Mset
                      setstore=zri
                      if @Cubic_Gradient==1&&(@Background==0||@Background==2)
                        arr2[n,m]=2
                      elseif @Cubic_Gradient==1
                        arr2[n,m]=3
                      elseif @Cubic_Gradient==0
                        arr2[n,m]=1
                      elseif @Cubic_Gradient==2
                        arr2[n,m]=8
                      elseif @Cubic_Gradient==3
                        arr2[n,m]=12
                      endif
                    endif
                  else
                    if zstoren1<zstoren2
                      zstore=zstore1
                    else
                      zstore=zstore2
                    endif
                  endif
                elseif @MSet==1
                  if @view==true
                    arr2[n,m]=4
                    if flagstore1==true&&flagstore2==true
                      arr[n,m]=istore1
                      if zstoren2<zstoren1
                        zstore=zstore2
                      else
                        zstore=zstore1
                      endif
                    elseif flagstore2==true
                      arr[n,m]=istore1
                      zstore=zstore1
                    elseif flagstore1==true
                      arr[n,m]=istore2
                      zstore=zstore2
                    elseif istore2<istore1
                      arr[n,m]=istore2
                      zstore=zstore2
                    else
                      arr[n,m]=istore1
                      zstore=zstore1
                    endif
                  elseif !(flagstore2==true&&flagstore1==true) ;Not both  View false
                    if flagstore1==true
                      setstore=-zri
                    elseif flagstore2==true
                      setstore=zri
                    elseif istore1<istore2
                      setstore=zri
                    else
                      setstore=-zri
                    endif
                  elseif zstoren2<zstoren1 ;Both
                    flag=true
                    setstore=-zri
                    if @Cubic_Gradient==1
                      arr2[n,m]=3
                    elseif @Cubic_Gradient==0
                      arr2[n,m]=1
                    elseif @Cubic_Gradient==2
                      arr2[n,m]=9
                    elseif @Cubic_Gradient==3
                      arr2[n,m]=13
                    endif
                  else
                    flag=true
                    setstore=zri  ;
                    if @Cubic_Gradient==1&&(@Background==0||@Background==2)
                      arr2[n,m]=2
                    elseif @Cubic_Gradient==1
                      arr2[n,m]=3
                    elseif @Cubic_Gradient==0
                      arr2[n,m]=1
                    elseif @Cubic_Gradient==2
                      arr2[n,m]=8
                    elseif @Cubic_Gradient==3
                      arr2[n,m]=12
                    endif
                  endif
                endif
              endif
            until counter==2
            t=t+1
        endwhile
        if @view==true
          if @MSet>1
            arr[n,m]=i
          endif
        endif
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Fourth__Dimension==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
              elseif @Fourth__Dimension==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)
              elseif @Fourth__Dimension==2
                zri=zj+flip(zk)
                zjk=zr+flip(zi)
              else
                zri=zk+flip(zj)
                zjk=zr+flip(zi)
              endif
              if @MSet<2
                cz=setstore
              elseif @MSet==2
                cz=zri
              else
                cz=-zri
              endif
              counter=0
              repeat
                if @MSet==1
                  counter=counter+1
                  if counter==2
                    cz=-setstore
                    i=0
                  endif
                else
                  counter=2
                endif
                repeat
                  cz=cz*cz*cz-3*zri*zri*cz+zjk
                  i=i+1
                until  i>=@maxiter|||cz|>@bailout
                if i<@maxiter
                  flag=false
                endif
              until counter==2||flag==false
              tt=tt+1
          endwhile
          tt=tt-1
          zstore=cz
        endif
        zarr_real[n,m]=round(real(zstore)*1000)
        zarr_imag[n,m]=round(imag(zstore)*1000)
        if @MSet>1
          if @view==true
            arr2[n,m]=4
            arr[n,m]=i
          elseif t<zz
              arr[n,m]=zmin+t*dz-tt*dz/@precision
              if arr[n,m]==zmin&&@touchscreen==true
                arr2[n,m]=5
              endif
          else
            if t>=zz
              arr[n,m]=zmax+dz
              if @Background==0
                arr2[n,m]=0
              elseif @Background==2
                arr2[n,m]=5
              elseif @Cubic_Gradient==0
                arr2[n,m]=6
              elseif @Cubic_Gradient==1
                arr2[n,m]=2
              elseif @Cubic_Gradient==2
                arr2[n,m]=7
              elseif @Cubic_Gradient==3
                arr2[n,m]=10
              endif
            endif
          endif
        else                ;MSet<2
          if @view==false
            if t<zz
              arr[n,m]=zmin+t*dz-tt*dz/@precision
              if arr[n,m]==zmin&&@touchscreen==true
                if (flagstore2==true||flagstore1==true)&&@MSet==0
                  arr2[n,m]=5
                elseif (flagstore2==true&&flagstore1==true)&&@MSet==1
                  arr2[n,m]=5
                endif
              endif
            else
              arr[n,m]=zmax+dz
              if @Background==0
              elseif @Background==2
                arr2[n,m]=5
              elseif @Cubic_Gradient==0
                arr2[n,m]=6
              elseif @Cubic_Gradient==1
                arr2[n,m]=2
              elseif @Cubic_Gradient==2
                arr2[n,m]=7
              elseif @Cubic_Gradient==3
                arr2[n,m]=10
              endif
            endif
          endif
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
    
    
  elseif @Formula==13   ;Quartics
    complex cz=0
    complex setstore=0
    complex zstore1=0
    complex zstore2=0
    complex zstore3=0
    complex zstore=0
    float zstoren1=0
    float zstoren2=0
    float zstoren3=0
    int istore1=0
    int istore2=0
    int istore3=0
    bool flagstore1=false
    bool flagstore2=false
    bool flagstore3=false
    if @Plotted_Space==0
      zk=@b_imag
      zl=@c_real
      zm=@c_imag
    elseif @Plotted_Space==1
      zk=@b_real
      zl=@c_real
      zm=@c_imag
    elseif @Plotted_Space==2
      zk=@c_imag
      zl=@b_real
      zm=@b_imag
    elseif @Plotted_Space==3
      zk=@c_real
      zl=@b_real
      zm=@b_imag
    elseif @Plotted_Space==4
      zk=@a_imag
      zl=@c_real
      zm=@c_imag
    elseif @Plotted_Space==5
      zk=@a_real
      zl=@c_real
      zm=@c_imag
    elseif @Plotted_Space==6
      zk=@c_imag
      zl=@a_real
      zm=@a_imag
    elseif @Plotted_Space==7
      zk=@c_real
      zl=@a_real
      zm=@a_imag
    elseif @Plotted_Space==8
      zk=@a_imag
      zl=@b_real
      zm=@b_imag
    elseif @Plotted_Space==9
      zk=@a_real
      zl=@b_real
      zm=@b_imag
    elseif @Plotted_Space==10
      zk=@b_imag
      zl=@a_real
      zm=@a_imag
    elseif @Plotted_Space==11
      zk=@b_real
      zl=@a_real
      zm=@a_imag
    elseif @Plotted_Space==12
      zk=@c_imag
      zl=@a_imag
      zm=@b_imag
    elseif @Plotted_Space==13
      zk=@c_real
      zl=@a_imag
      zm=@b_imag
    elseif @Plotted_Space==14
      zk=@c_imag
      zl=@a_imag
      zm=@b_real
    elseif @Plotted_Space==15
      zk=@c_real
      zl=@a_imag
      zm=@b_real
    elseif @Plotted_Space==16
      zk=@c_imag
      zl=@a_real
      zm=@b_imag
    elseif @Plotted_Space==17
      zk=@c_real
      zl=@a_real
      zm=@b_imag
    elseif @Plotted_Space==18
      zk=@c_imag
      zl=@a_real
      zm=@b_real
    else
      zk=@c_real
      zl=@a_real
      zm=@b_real
    endif
    m=0
    while m<=yy
      n=0
      while n<=xx
        t=0
        zr=rxmin+n*dxx+m*dyx
        zi=rymin+n*dxy+m*dyy
        zj=rzmin+n*dxz+m*dyz
        flag=false
        while (t<=zz)&&(flag==false)
            zr=zr+dzx
            zi=zi+dzy
            zj=zj+dzz
            if @Plotted_Space==0
              zri=zr+flip(zi)     
              zjk=zj+flip(zk)
              zlm=zl+flip(zm)
            elseif @Plotted_Space==1
              zri=zr+flip(zi)     
              zjk=zk+flip(zj)
              zlm=zl+flip(zm)
            elseif @Plotted_Space==2
              zri=zr+flip(zi)     
              zjk=zl+flip(zm)
              zlm=zj+flip(zk)
            elseif @Plotted_Space==3
              zri=zr+flip(zi)     
              zjk=zl+flip(zm)
              zlm=zk+flip(zj)
            elseif @Plotted_Space==4
              zri=zj+flip(zk)     
              zjk=zr+flip(zi)
              zlm=zl+flip(zm)
            elseif @Plotted_Space==5
              zri=zk+flip(zj)     
              zjk=zr+flip(zi)
              zlm=zl+flip(zm)
            elseif @Plotted_Space==6
              zri=zl+flip(zm)     
              zjk=zr+flip(zi)
              zlm=zj+flip(zk)
            elseif @Plotted_Space==7
              zri=zl+flip(zm)     
              zjk=zr+flip(zi)
              zlm=zk+flip(zj)
            elseif @Plotted_Space==8
              zri=zj+flip(zk)     
              zjk=zl+flip(zm)
              zlm=zr+flip(zi)
            elseif @Plotted_Space==9
              zri=zk+flip(zj)     
              zjk=zl+flip(zm)
              zlm=zr+flip(zi)
            elseif @Plotted_Space==10
              zri=zl+flip(zm)     
              zjk=zj+flip(zk)
              zlm=zr+flip(zi)
            elseif @Plotted_Space==11
              zri=zl+flip(zm)     
              zjk=zk+flip(zj)
              zlm=zr+flip(zi)
            elseif @Plotted_Space==12
              zri=zr+flip(zl)     
              zjk=zi+flip(zm)
              zlm=zj+flip(zk)
            elseif @Plotted_Space==13
              zri=zr+flip(zl)     
              zjk=zi+flip(zm)
              zlm=zk+flip(zj)
            elseif @Plotted_Space==14
              zri=zr+flip(zl)     
              zjk=zm+flip(zi)
              zlm=zj+flip(zk)
            elseif @Plotted_Space==15
              zri=zr+flip(zl)     
              zjk=zm+flip(zi)
              zlm=zk+flip(zj)
            elseif @Plotted_Space==16
              zri=zl+flip(zr)     
              zjk=zi+flip(zm)
              zlm=zj+flip(zk)
            elseif @Plotted_Space==17
              zri=zl+flip(zr)     
              zjk=zi+flip(zm)
              zlm=zk+flip(zj)
            elseif @Plotted_Space==18
              zri=zl+flip(zr)     
              zjk=zm+flip(zi)
              zlm=zj+flip(zk)
            else
              zri=zl+flip(zr)     
              zjk=zm+flip(zi)
              zlm=zk+flip(zj)
            endif
            counter=0
            repeat
            flag=false
              i=0
              if @QMSet<2
                counter=counter+1
                if counter==1
                  cz=zri
                elseif counter==2
                  cz=zjk
                else
                  cz=-zri-zjk
                endif
              elseif @QMSet==2
                cz=zri
              elseif @QMSet==3
                cz=zjk
              elseif @QMSet==4
                cz=-zri-zjk
              elseif @QMSet==5
                counter=counter+1
                if counter==1
                  cz=zri
                elseif counter==2
                  cz=zjk
                endif
              elseif @QMSet==6
                counter=counter+1
                if counter==1
                  cz=zri
                elseif counter==2
                  cz=-zri-zjk
                endif
              elseif @QMSet==7
                counter=counter+1
                if counter==1
                  cz=zjk
                elseif counter==2
                  cz=-zri-zjk
                endif
              endif
              repeat
                  cz=cz*cz*cz*cz+2*(zri*zjk-(zri+zjk)*(zri+zjk))*cz*cz+4*zri*zjk*(zri+zjk)*cz+zlm
                  i=i+1
                  if i==@maxiter
                    flag=true
                  endif
              until  i>=@maxiter|||cz|>@bailout
              zstore=cz
              if @QMSet>1&&@QMSet<5
                counter=3
                if @view==false
                  if flag==true
                    if @Quartic_Gradient==0
                      arr2[n,m]=1
                    elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                      if @QMSet==2
                        arr2[n,m]=2
                      else
                        arr2[n,m]=3
                      endif
                    elseif @Quartic_Gradient==1
                      arr2[n,m]=3
                    elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                      if @QMSet==2
                        arr2[n,m]=7
                      elseif @QMSet==3
                        arr2[n,m]=8
                      else
                        arr2[n,m]=9
                      endif
                    elseif @Quartic_Gradient==2
                      if @QMSet==2
                        arr2[n,m]=8
                      else
                        arr2[n,m]=9
                      endif
                    elseif @Quartic_Gradient==3
                      if @QMSet==2
                        arr2[n,m]=11
                      elseif @QMSet==3
                        arr2[n,m]=12
                      else
                        arr2[n,m]=13
                      endif
                    endif
                  endif
                endif
              elseif counter==1
                istore1=i
                zstore1=cz
                zstoren1=|cz|
                flagstore1=flag
                flag=false
              elseif counter==2
                istore2=i
                zstore2=cz
                zstoren2=|cz|
                flagstore2=flag
                flag=false
                if @QMSet==5
                  if @view==true
                    arr2[n,m]=4
                    if flagstore1==true||flagstore2==true
                      if flagstore1==true
                        arr[n,m]=istore1
                      elseif flagstore2==true
                        arr[n,m]=istore2
                      endif
                      if flagstore1==true
                        zstore=zstore1
                        if flagstore2==true
                          if zstoren2<zstoren1
                            zstore=zstore2
                          endif
                        endif
                      elseif flagstore2==true
                        zstore=zstore2
                      endif
                    else  ; view and no set
                      if istore1>istore2
                        zstore=zstore1
                        arr[n,m]=istore1
                      else
                        zstore=zstore2
                        arr[n,m]=istore2
                      endif
                    endif    ;view is false QMSet=5
                  elseif flagstore1==true||flagstore2==true
                    flag=true
                    if flagstore1==true&&flagstore2==true
                      setstore=zri
                      if zstoren1<zstoren2
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                          arr2[n,m]=2
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=7
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=8
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=11
                        endif
                      else
                        setstore=zjk
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=8
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=12
                        endif
                      endif   ;Ma and rest
                    elseif flagstore1==true
                      flag=flagstore1
                      setstore=zri
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                        arr2[n,m]=2
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                        arr2[n,m]=7
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=8
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=11
                      endif
                    elseif flagstore2==true
                      setstore=zjk
                      flag=flagstore2
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                        arr2[n,m]=8
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=9
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=12
                      endif
                    endif
                  endif
                  counter=3
                
                elseif @QMSet==6
                  if @view==true
                    arr2[n,m]=4
                    if flagstore1==true||flagstore2==true
                      if flagstore1==true
                        arr[n,m]=istore1
                      elseif flagstore2==true
                        arr[n,m]=istore2
                      endif
                      if flagstore1==true
                        zstore=zstore1
                        if flagstore2==true
                          if zstoren2<zstoren1
                            zstore=zstore2
                          endif
                        endif
                      elseif flagstore2==true
                        zstore=zstore2
                      endif
                    else  ; view and no set
                      if istore1>istore2
                        zstore=zstore1
                        arr[n,m]=istore1
                      else
                        zstore=zstore2
                        arr[n,m]=istore2
                      endif
                    endif    ;view is false QMSet=6
                  elseif flagstore1==true||flagstore2==true
                    flag=true
                    if flagstore1==true&&flagstore2==true
                      setstore=zri
                      if zstoren1<zstoren2
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                          arr2[n,m]=2
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=7
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=8
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=11
                        endif
                      else
                        setstore=-zri-zjk
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=13
                        endif
                      endif   ;Ma
                    elseif flagstore1==true
                      flag=flagstore1
                      setstore=zri
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                        arr2[n,m]=2
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                        arr2[n,m]=7
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=8
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=11
                      endif
                    elseif flagstore2==true
                      setstore=-zri-zjk
                      flag=flagstore2
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=9
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=13
                      endif
                    endif
                  endif
                  counter=3

                elseif @QMSet==7
                  if @view==true
                    arr2[n,m]=4
                    if flagstore1==true||flagstore2==true
                      if flagstore1==true
                        arr[n,m]=istore1
                      elseif flagstore2==true
                        arr[n,m]=istore2
                      endif
                      if flagstore1==true
                        zstore=zstore1
                        if flagstore2==true
                          if zstoren2<zstoren1
                            zstore=zstore2
                          endif
                        endif
                      elseif flagstore2==true
                        zstore=zstore2
                      endif
                    else  ; view and no set
                      if istore1>istore2
                        zstore=zstore1
                        arr[n,m]=istore1
                      else
                        zstore=zstore2
                        arr[n,m]=istore2
                      endif
                    endif    ;view is false QMSet=7
                  elseif flagstore1==true||flagstore2==true
                    flag=true
                    if flagstore1==true&&flagstore2==true
                      setstore=zjk
                      if zstoren1<zstoren2
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                          arr2[n,m]=2
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=8
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=12
                        endif
                      else
                        setstore=-zri-zjk
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=13
                        endif
                      endif   ;Ma
                    elseif flagstore1==true
                      flag=flagstore1
                      setstore=zjk
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                        arr2[n,m]=2
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=8
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=12
                      endif
                    elseif flagstore2==true
                      setstore=-zri-zjk
                      flag=flagstore2
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=9
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=13
                      endif
                    endif
                  endif
                  counter=3
                endif
                
              elseif counter==3
                istore3=i
                zstore3=cz
                zstoren3=|cz|
                flagstore3=flag
                flag=false
                if @QMSet==0
                  if @view==true
                    arr2[n,m]=4
                    if flagstore1==true||flagstore2==true||flagstore3==true
                      if flagstore1==true
                        arr[n,m]=istore1
                      elseif flagstore2==true
                        arr[n,m]=istore2
                      else
                        arr[n,m]=istore3
                      endif
                      if flagstore1==true
                        zstore=zstore1
                        if flagstore2==true
                          if zstoren1<zstoren2
                            if flagstore3==true
                              if zstoren3<zstoren1
                                zstore=zstore3
                              endif
                            endif
                          elseif flagstore3==true
                            if zstoren3<zstoren2
                              zstore=zstore3
                            else
                              zstore=zstore2
                            endif
                          else
                            zstore=zstore2
                          endif
                        elseif flagstore3==true
                          if zstoren3<zstoren1
                            zstore=zstore3
                          endif
                        endif
                      elseif flagstore2==true
                        zstore=zstore2
                        if flagstore3==true
                          if zstoren3<zstoren2
                            zstore=zstore3
                          endif
                        endif
                      else
                        zstore=zstore3
                      endif
                    else  ; view and no set
                      if istore1>istore2
                        zstore=zstore1
                        arr[n,m]=istore1
                        if  istore3>istore1
                          zstore=zstore3
                          arr[n,m]=istore3
                        endif
                      elseif istore2>istore3
                        zstore=zstore2
                        arr[n,m]=istore2
                      else
                        zstore=zstore3
                        arr[n,m]=istore3
                      endif
                    endif    ;view is false QMSet=0
                  elseif flagstore1==true||flagstore2==true||flagstore3==true
                    flag=true
                    if flagstore1==true&&flagstore2==true&&flagstore3==true
                      setstore=zri
                      if zstoren1<zstoren2
                        if zstoren1<zstoren3
                          if @Quartic_Gradient==0
                            arr2[n,m]=1
                          elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                            arr2[n,m]=2
                          elseif @Quartic_Gradient==1
                            arr2[n,m]=3
                          elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                            arr2[n,m]=7
                          elseif @Quartic_Gradient==2
                            arr2[n,m]=8
                          elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                            arr2[n,m]=10
                          elseif @Quartic_Gradient==3
                            arr2[n,m]=11
                          endif
                        else
                          setstore=-zri-zjk
                          if @Quartic_Gradient==0
                            arr2[n,m]=1
                          elseif @Quartic_Gradient==1
                            arr2[n,m]=3
                          elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                            arr2[n,m]=9
                          elseif @Quartic_Gradient==2
                            arr2[n,m]=9
                          elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                            arr2[n,m]=10
                          elseif @Quartic_Gradient==3
                            arr2[n,m]=13
                          endif
                        endif
                      elseif zstoren2<zstoren3
                        setstore=zjk
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=8
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=12
                        endif
                      else
                        setstore=-zri-zjk
                        if @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==3&&(@Background==0||@Background==2)
                          arr2[n,m]=10
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=13
                        endif
                      endif   ;Ma and rest
                    elseif flagstore1==true
                      flag=flagstore1
                      setstore=zri
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1&&(@Background==0||@Background==2)
                        arr2[n,m]=2
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                        arr2[n,m]=7
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=8
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=11
                      endif
                      if flagstore2==true
                        if zstoren2<zstoren1
                          setstore=zjk
                          flag=flagstore2
                          if @Quartic_Gradient==0
                            arr2[n,m]=1
                          elseif @Quartic_Gradient==1
                            arr2[n,m]=3
                          elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                            arr2[n,m]=8
                          elseif @Quartic_Gradient==2
                            arr2[n,m]=9
                          elseif @Quartic_Gradient==3
                            arr2[n,m]=12
                          endif
                        endif
                      elseif flagstore3==true
                        if zstoren3<zstoren1
                          setstore=-zri-zjk
                          flag=flagstore3
                          if @Quartic_Gradient==0
                            arr2[n,m]=1
                          elseif @Quartic_Gradient==1
                            arr2[n,m]=3
                          elseif @Quartic_Gradient==2
                            arr2[n,m]=9
                          elseif @Quartic_Gradient==3
                            arr2[n,m]=13
                          endif
                        endif
                      endif   ;Mb and -Ma-Mb
                    elseif flagstore2==true
                      setstore=zjk
                      flag=flagstore2
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                        arr2[n,m]=8
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=9
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=12
                      endif
                      if flagstore3==true
                        if zstoren3<zstoren2
                          setstore=-zri-zjk
                          flag=flagstore3
                          if @Quartic_Gradient==0
                            arr2[n,m]=1
                          elseif @Quartic_Gradient==1
                            arr2[n,m]=3
                          elseif @Quartic_Gradient==2
                            arr2[n,m]=9
                          elseif @Quartic_Gradient==3
                            arr2[n,m]=13
                          endif
                        endif
                      endif
                    else
                      setstore=-zri-zjk
                      flag=flagstore3
                      if @Quartic_Gradient==0
                        arr2[n,m]=1
                      elseif @Quartic_Gradient==1
                        arr2[n,m]=3
                      elseif @Quartic_Gradient==2
                        arr2[n,m]=9
                      elseif @Quartic_Gradient==3
                        arr2[n,m]=13
                      endif
                    endif
                  endif
                elseif @QMSet==1  ;QCL !!!!!!!!!!!
                  flag=false
                  if @view==true
                    arr2[n,m]=4
                    if flagstore1==true&&flagstore2==true&&flagstore3==true
                      arr[n,m]=i
                      zstore=zstore1
                      if zstoren2<zstoren1
                        if zstoren2<zstoren3
                          zstore=zstore2
                        else
                          zstore=zstore3
                        endif
                      elseif zstoren3<zstoren1
                        zstore=zstore3
                      endif
                    elseif flagstore1==true&&flagstore2==true
                      zstore=zstore3
                      arr[n,m]=istore3
                    elseif flagstore1==true&&flagstore3==true
                      zstore=zstore2
                      arr[n,m]=istore2
                    elseif flagstore2==true&&flagstore3==true
                      zstore=zstore1
                      arr[n,m]=istore1
                    elseif flagstore1==true
                      if istore2<istore3
                        zstore=zstore2
                        arr[n,m]=istore2
                      else
                        zstore=zstore3
                        arr[n,m]=istore3
                      endif
                    elseif flagstore2==true
                      if istore1<istore3
                        zstore=zstore1
                        arr[n,m]=istore1
                      else
                        zstore=zstore3
                        arr[n,m]=istore3
                      endif
                    elseif flagstore3==true
                      if istore1<istore2
                        zstore=zstore1
                        arr[n,m]=istore1
                      else
                        zstore=zstore2
                        arr[n,m]=istore2
                      endif
                    else
                      if istore1<istore2
                        if istore1<istore3
                          zstore=zstore1
                          arr[n,m]=istore1
                        else
                          zstore=zstore3
                          arr[n,m]=istore3
                        endif
                      elseif istore2<istore3
                        zstore=zstore2
                        arr[n,m]=istore2
                      else
                        zstore=zstore3
                        arr[n,m]=istore3
                      endif
                    endif
                  else   ;Not view. QCL-3d
                    if !(flagstore1==true&&flagstore2==true&&flagstore3==true)
                      flag=false
                    else   ;all three true
                      flag=true
                      if zstoren1<zstoren2
                        if zstoren1<zstoren3
                          if @Quartic_Gradient==1&&(@Background==0||@Background==2)
                            arr2[n,m]=2
                          elseif @Quartic_Gradient==1
                            arr2[n,m]=3
                          elseif @Quartic_Gradient==0
                            arr2[n,m]=1
                          elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                            arr2[n,m]=7
                          elseif @Quartic_Gradient==2
                            arr2[n,m]=8
                          elseif @Quartic_Gradient==3
                            arr2[n,m]=11
                          endif
                        else
                          if @Quartic_Gradient==1
                            arr2[n,m]=3
                          elseif @Quartic_Gradient==0
                            arr2[n,m]=1
                          elseif @Quartic_Gradient==2
                            arr2[n,m]=9
                          elseif @Quartic_Gradient==3
                            arr2[n,m]=13
                          endif
                        endif
                      elseif zstoren2<zstoren3
                        if @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==2&&(@Background==0||@Background==2)
                          arr2[n,m]=8
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=12
                        endif
                      else
                        if @Quartic_Gradient==1
                          arr2[n,m]=3
                        elseif @Quartic_Gradient==0
                          arr2[n,m]=1
                        elseif @Quartic_Gradient==2
                          arr2[n,m]=9
                        elseif @Quartic_Gradient==3
                          arr2[n,m]=13
                        endif
                      endif
                    endif
                  endif
                endif
              endif
            until counter==3
            t=t+1
        endwhile
        if @view==true
          if @QMSet>1&&@QMSet<5
            arr[n,m]=i
            flag=false
          endif
        endif
        t=t-1
        tt=0
        if (flag==true)&&(t>0)
          while flag==true
              i=0
              zr=zr-dzx1
              zi=zi-dzy1
              zj=zj-dzz1
              if @Plotted_Space==0
                zri=zr+flip(zi)     
                zjk=zj+flip(zk)
                zlm=zl+flip(zm)
              elseif @Plotted_Space==1
                zri=zr+flip(zi)     
                zjk=zk+flip(zj)
                zlm=zl+flip(zm)
              elseif @Plotted_Space==2
                zri=zr+flip(zi)     
                zjk=zl+flip(zm)
                zlm=zj+flip(zk)
              elseif @Plotted_Space==3
                zri=zr+flip(zi)     
                zjk=zl+flip(zm)
                zlm=zk+flip(zj)
              elseif @Plotted_Space==4
                zri=zj+flip(zk)     
                zjk=zr+flip(zi)
                zlm=zl+flip(zm)
              elseif @Plotted_Space==5
                zri=zk+flip(zj)     
                zjk=zr+flip(zi)
                zlm=zl+flip(zm)
              elseif @Plotted_Space==6
                zri=zl+flip(zm)     
                zjk=zr+flip(zi)
                zlm=zj+flip(zk)
              elseif @Plotted_Space==7
                zri=zl+flip(zm)     
                zjk=zr+flip(zi)
                zlm=zk+flip(zj)
              elseif @Plotted_Space==8
                zri=zj+flip(zk)     
                zjk=zl+flip(zm)
                zlm=zr+flip(zi)
              elseif @Plotted_Space==9
                zri=zk+flip(zj)     
                zjk=zl+flip(zm)
                zlm=zr+flip(zi)
              elseif @Plotted_Space==10
                zri=zl+flip(zm)     
                zjk=zj+flip(zk)
                zlm=zr+flip(zi)
              elseif @Plotted_Space==11
                zri=zl+flip(zm)     
                zjk=zk+flip(zj)
                zlm=zr+flip(zi)
              elseif @Plotted_Space==12
                zri=zr+flip(zl)     
                zjk=zi+flip(zm)
                zlm=zj+flip(zk)
              elseif @Plotted_Space==13
                zri=zr+flip(zl)     
                zjk=zi+flip(zm)
                zlm=zk+flip(zj)
              elseif @Plotted_Space==14
                zri=zr+flip(zl)     
                zjk=zm+flip(zi)
                zlm=zj+flip(zk)
              elseif @Plotted_Space==15
                zri=zr+flip(zl)     
                zjk=zm+flip(zi)
                zlm=zk+flip(zj)
              elseif @Plotted_Space==16
                zri=zl+flip(zr)     
                zjk=zi+flip(zm)
                zlm=zj+flip(zk)
              elseif @Plotted_Space==17
                zri=zl+flip(zr)     
                zjk=zi+flip(zm)
                zlm=zk+flip(zj)
              elseif @Plotted_Space==18
                zri=zl+flip(zr)     
                zjk=zm+flip(zi)
                zlm=zj+flip(zk)
              else
                zri=zl+flip(zr)     
                zjk=zm+flip(zi)
                zlm=zk+flip(zj)
              endif
              if @QMSet==0||@QMSet==5||@QMSet==6||@QMSet==7
                cz=setstore
              elseif @QMSet==2
                cz=zri
              elseif @QMSet==3
                cz=zjk
              elseif @QMSet==4
                cz=-zri-zjk
              endif
              counter=0
              repeat
                i=0
                if @QMSet==1
                  counter=counter+1
                  if counter==1
                    cz=zri
                  elseif counter==2
                    cz=zjk
                  else
                    cz=-zri-zjk
                  endif
                else
                  counter=3
                endif
                repeat
                  cz=cz*cz*cz*cz+2*(zri*zjk-(zri+zjk)*(zri+zjk))*cz*cz+4*zri*zjk*(zri+zjk)*cz+zlm
                  i=i+1
                until  i>=@maxiter|||cz|>@bailout
                if i<@maxiter
                  flag=false
                endif
              until counter==3||flag==false
              tt=tt+1
              zstore=cz
          endwhile
          tt=tt-1
        endif
        zarr_real[n,m]=round(real(zstore)*1000)
        zarr_imag[n,m]=round(imag(zstore)*1000)
        if @QMSet>1&&@QMSet<5
          if @view==true
            arr2[n,m]=4
            arr[n,m]=i
          elseif t<zz
              arr[n,m]=zmin+t*dz-tt*dz/@precision
              if arr[n,m]==zmin&&@touchscreen==true
                arr2[n,m]=5
              endif
          else
            if t>=zz
              arr[n,m]=zmax+dz
              if @Background==0
                arr2[n,m]=0
              elseif @Background==2
                arr2[n,m]=5
              elseif @Quartic_Gradient==0
                arr2[n,m]=6
              elseif @Quartic_Gradient==1
                arr2[n,m]=2
              elseif @Quartic_Gradient==2
                arr2[n,m]=7
              elseif @Quartic_Gradient==3
                arr2[n,m]=10
              endif
            endif
          endif
        else                ;QMSet<2
          if @view==false
            if t<zz
              arr[n,m]=zmin+t*dz-tt*dz/@precision
              if arr[n,m]==zmin&&@touchscreen==true
                if (flagstore1==true||flagstore2==true||flagstore3==true)&&(@QMSet==0||@QMSet==5||@QMSet==6||@QMSet==7)
                  arr2[n,m]=5
                elseif (flagstore1==true&&flagstore2==true&&flagstore3==true)&&@QMSet==1
                  arr2[n,m]=5
                endif
              endif
            else
              arr[n,m]=zmax+dz
              if @Background==0
                arr2[n,m]=0
              elseif @Background==2
                arr2[n,m]=5
              elseif @Quartic_Gradient==0
                arr2[n,m]=6
              elseif @Quartic_Gradient==1
                arr2[n,m]=2
              elseif @Quartic_Gradient==2
                arr2[n,m]=7
              elseif @Quartic_Gradient==3
                arr2[n,m]=10
              endif
            endif
          endif
        endif
        n=n+1
      endwhile
      m=m+1
    endwhile
  endif
   
init:
  complex z=zarr_real[#x+1,#y+1]/1000+1i*zarr_imag[#x+1,#y+1]/1000
  int jj=0
  int gg=0
  int kk=0
  float bb=0
  float arrXr=arr[#x+2,#y+1]
  float arrXl=arr[#x,#y+1]
  float arrYr=arr[#x+1,#y+2]
  float arrYl=arr[#x+1,#y]
  float lightdx=0
  float lightdy=0
  float lightdz=0
  float lightlength=0
  float fx=0
  float fy=0
  float fz=0
  float flength=0
  float aa=0
  if @view==false
    if @Background==1&&((@Formula!=12&&@Formula!=13&&@Gradient==1)|| \
      (@Formula==12&&@Cubic_Gradient==1)||(@Formula==13&&@Quartic_Gradient==1))&&arr2[#x+1,#y+1]==2
      if arr2[#x,#y+1]==3
        arrXl=arr[#x+1,#y+1]
      endif
      if arr2[#x+2,#y+1]==3
        arrXr=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y]==3
        arrYl=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y+2]==3
        arrYr=arr[#x+1,#y+1]
      endif
    
    elseif @Background==1&&((@Formula!=12&&@Formula!=13&&@Gradient==0)|| \
              (@Formula==12&&@Cubic_Gradient==0)||(@Formula==13&&@Quartic_Gradient==0))&&arr2[#x+1,#y+1]==6
      if arr2[#x,#y+1]==1
        arrXl=arr[#x+1,#y+1]
      endif
      if arr2[#x+2,#y+1]==1
        arrXr=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y]==1
        arrYl=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y+2]==1
        arrYr=arr[#x+1,#y+1]
      endif

    elseif @Background==1&& ((@Formula==12&&@Cubic_Gradient==2)||(@Formula==13&&@Quartic_Gradient==2))&&arr2[#x+1,#y+1]==7
      if arr2[#x,#y+1]!=7
        arrXl=arr[#x+1,#y+1]
      endif
      if arr2[#x+2,#y+1]!=7
        arrXr=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y]!=7
        arrYl=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y+2]!=7
        arrYr=arr[#x+1,#y+1]
      endif
      
    elseif @Background==1&&((@Formula==12&&@Cubic_Gradient==3)||(@Formula==13&&@Quartic_Gradient==3))&&arr2[#x+1,#y+1]==10
      if arr2[#x,#y+1]!=10
        arrXl=arr[#x+1,#y+1]
      endif
      if arr2[#x+2,#y+1]!=10
        arrXr=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y]!=10
        arrYl=arr[#x+1,#y+1]
      endif
      if arr2[#x+1,#y+2]!=10
        arrYr=arr[#x+1,#y+1]
      endif
    endif
      
    lightdx=(#x+1)*dx+xmin-@lightx
    lightdy=(#y+1)*dy+ymin-@lighty
    lightdz=arr[#x+1,#y+1]+@lightz
    lightlength=sqrt(lightdx^2+lightdy^2+lightdz^2)
    fx=(arrXr-arrXl)*2*dy
    fy=(arrYr-arrYl)*2*dx
    fz=-4*dx*dy
    flength=sqrt(fx^2+fy^2+fz^2)
    aa=(fx*lightdx+fy*lightdy+fz*lightdz)/(flength*lightlength)
  else
    aa=arr[#x+1,#y+1]
  endif

  
  if @Coloring==0
    kk=round(#maxiter/100)
    if arr2[#x+1,#y+1]==5
      kk=0
      jj=1
    elseif arr2[#x+1,#y+1]==0
      aa=0
      jj=0
    elseif arr2[#x+1,#y+1]==1
      aa=0.99*((aa+1)/2)
      jj=round(#maxiter*aa)
    elseif arr2[#x+1,#y+1]==6
      aa=0.99*((aa+1)/2)
      jj=round(#maxiter*aa)
    elseif arr2[#x+1,#y+1]==2
      aa=(aa+1)/2
      bb=aa/2
      aa=aa*0.49
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==3
      aa=(aa+1)/2
      bb=aa/2+0.5
      aa=aa*0.49+0.5
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==7
      aa=(aa+1)/2
      bb=aa/3
      aa=aa*0.32
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==8
      aa=(aa+1)/2
      bb=aa/3+0.33
      aa=aa*0.32+0.33
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==9
      aa=(aa+1)/2
      bb=aa/3+0.67
      aa=aa*0.32+0.67
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==10
      aa=(aa+1)/2
      bb=aa/4
      aa=aa*0.24
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==11

      aa=(aa+1)/2
      bb=aa/4+0.25
      aa=aa*0.24+0.25
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==12
      aa=(aa+1)/2
      bb=aa/4+0.5
      aa=aa*0.24+0.5
      jj=round(#maxiter*bb)
    elseif arr2[#x+1,#y+1]==13
      aa=(aa+1)/2
      bb=aa/4+0.75
      aa=aa*0.24+0.75
      jj=round(#maxiter*bb)
    else
       aa=arr[#x+1,#y+1]
       if aa==@maxiter
         aa=aa*#maxiter
       endif
       jj=round(aa)+1
    endif
  endif
    
  
loop:
  if @Coloring==0
    gg=gg+kk
  elseif @Coloring==1
    if  @view==false
      if arr2[#x+1,#y+1]==5
        jj=-1
      else
        z=aa+flip(arr2[#x+1,#y+1])
      endif
    else
      if aa==@maxiter
        jj=-1
      else
        z=round(aa)+1+flip(arr2[#x+1,#y+1])
      endif
    endif
  endif
bailout:
  (@Coloring==0&&gg<jj)||(@Coloring==1&&jj<0)
default:
  title = "Raytrace2"
  render=false
  method=onepass

  periodicity=0

  maxiter=100
  
  heading
    caption="Set Drawing Method to: One-pass."
  endheading
  
  heading
    caption="Set Periodicity Checking to: Off."
  endheading
  
  heading

    caption="Set Maximum Iterations to: 100."
  endheading
  
  heading
    caption="Use Max Iterations below instead."
  endheading
  
  heading

    caption="And.. Don't Render. Export instead."
  endheading
  
  heading
  endheading
  

  heading
    caption="Happy Fractalling!"
    visible=@Formula==12&&@MSet==1&&@precision==123
  endheading
  
  
  heading
    caption="Quaternion"
    visible=@Formula==0
  endheading

  heading

    caption="Hypernion"
    visible=@Formula==1
  endheading
  
  heading
    caption="z=z^2+c    Maps on HyperComplex(z)"
    visible=@Formula==0||@Formula==1
  endheading
  
  heading
    caption="Quaternion 2"
    visible=@Formula==2
  endheading
  
  heading
    caption="Hypernion 2"
    visible=@Formula==3
  endheading
  
  heading
    caption="z=cz(1-z)    Maps on HyperComplex(z)"
    visible=@Formula==2||@Formula==3
  endheading
  
  heading
    caption="Cubic Quaternion"
    visible=@Formula==4
  endheading
  
  
  heading
    caption="Cubic Hypernion"
    visible=@Formula==5
  endheading
  
  heading
    caption="z=z^3-3a^2z+b  Maps on HyperComplex(z)"
    visible=@Formula==4||@Formula==5
  endheading
  
  heading
    caption="Quatbrot"
    visible=@Formula==6
  endheading
  
  heading
    caption="Hyperbrot"
    visible=@Formula==7
  endheading
  
  heading
    caption="z=z^2+c    Maps on HyperComplex(c)"
    visible=@Formula==6||@Formula==7
  endheading

  
  heading
    caption="Quatbrot 2"
    visible=@Formula==8
  endheading
  
  heading
    caption="Hyperbrot 2"
    visible=@Formula==9
  endheading
  
  heading
    caption="z=cz(1-z)    Maps on HyperComplex(c)"
    visible=@Formula==8||@Formula==9
  endheading
  
  heading
    caption="Juliabrot"
    visible=@Formula==10
  endheading

  
  heading
    caption="z=z^2+c    Maps on Complex(z,c)"
    visible=@Formula==10
  endheading
  
  heading
    caption="Juliabrot 2"
    visible=@Formula==11
  endheading
  
  heading
    caption="z=cz(1-z)    Maps on Complex(z,c)"
    visible=@Formula==11
  endheading
  
  heading

    caption="Cubic Parameterspace  "
    visible=@Formula==12
  endheading
  
  heading
    caption="z=z^3-3a^2z+b    Maps on Complex(a,b)"
    visible=@Formula==12
  endheading
  
  
  heading
    caption="Quartic Parameterspace  "
    visible=@Formula==13
  endheading
  
  heading
    caption="z=z^4+2[ab-(a+b)^2]z^2+4ab(a+b)z+c"
    visible=@Formula==13
  endheading
  
  heading
    caption="Maps on Complex(a,b,c)"
    visible=@Formula==13
  endheading
  
  
  heading
    caption="Plot:  a_real;  a_imag;  b_real"
    visible=@Formula==13&&@Plotted_Space==0
  endheading
  
  heading
    caption="Plot:  a_real;  a_imag;  b_imag"
    visible=@Formula==13&&@Plotted_Space==1
  endheading
  
  heading
    caption="Plot:  a_real;  a_imag;  c_real"
    visible=@Formula==13&&@Plotted_Space==2
  endheading
  
  heading
    caption="Plot:  a_real;  a_imag;  c_imag"
    visible=@Formula==13&&@Plotted_Space==3
  endheading
  
  heading
    caption="Plot:  b_real;  b_imag;  a_real"
    visible=@Formula==13&&@Plotted_Space==4
  endheading
  
  heading
    caption="Plot:  b_real;  b_imag;  a_imag"
    visible=@Formula==13&&@Plotted_Space==5
  endheading
  
  heading
    caption="Plot:  b_real;  b_imag;  c_real"
    visible=@Formula==13&&@Plotted_Space==6
  endheading
  
  heading
    caption="Plot:  b_real;  b_imag;  c_imag"
    visible=@Formula==13&&@Plotted_Space==7
  endheading
  
  heading
    caption="Plot:  c_real;  c_imag;  a_real"
    visible=@Formula==13&&@Plotted_Space==8
  endheading

  heading
    caption="Plot:  c_real;  c_imag;  a_imag"
    visible=@Formula==13&&@Plotted_Space==9
  endheading
  
  heading
    caption="Plot:  c_real;  c_imag;  b_real"
    visible=@Formula==13&&@Plotted_Space==10
  endheading
  
  heading
    caption="Plot:  c_real;  c_imag;  b_imag"
    visible=@Formula==13&&@Plotted_Space==11
  endheading
  
  heading
    caption="Plot:  a_real;  b_real;  c_real"
    visible=@Formula==13&&@Plotted_Space==12
  endheading
  
  heading
    caption="Plot:  a_real;  b_real;  c_imag"
    visible=@Formula==13&&@Plotted_Space==13
  endheading
  
  heading
    caption="Plot:  a_real;  b_imag;  c_real"
    visible=@Formula==13&&@Plotted_Space==14
  endheading
  
  heading
    caption="Plot:  a_real;  b_imag;  c_imag"
    visible=@Formula==13&&@Plotted_Space==15
  endheading
  
  heading
    caption="Plot:  a_imag;  b_real;  c_real"
    visible=@Formula==13&&@Plotted_Space==16
  endheading
  
  heading
    caption="Plot:  a_imag;  b_real;  c_imag"
    visible=@Formula==13&&@Plotted_Space==17
  endheading
  
  heading
    caption="Plot:  a_imag;  b_imag;  c_real"
    visible=@Formula==13&&@Plotted_Space==18
  endheading
  
  heading
    caption="Plot:  a_imag;  b_imag;  c_imag"
    visible=@Formula==13&&@Plotted_Space==19
  endheading
  
  
  
  heading
    caption="Plot:  a_real;  a_imag;  b_real"
    visible=@Formula==12&&@Fourth__Dimension==0
  endheading
  
  heading
    caption="Plot:  a_real;  a_imag;  b_imag"
    visible=@Formula==12&&@Fourth__Dimension==1
  endheading
  
  heading
    caption="Plot:  b_real;  b_imag;  a_real"
    visible=@Formula==12&&@Fourth__Dimension==2
  endheading
  
  heading
    caption="Plot:  b_real;  b_imag;  a_imag"
    visible=@Formula==12&&@Fourth__Dimension==3
  endheading
  
  heading
    caption="Plot:  z_real;  z_imag;  z_j"
    visible=@Formula==0||@Formula==1||@Formula==2||@Formula==3||@Formula==4\ 
                ||@Formula==5&&@Fourth_Dimension==0
  endheading
  
  heading
    caption="Plot:  z_real;  z_imag;  z_k"
    visible=@Formula==0||@Formula==1||@Formula==2||@Formula==3||@Formula==4\ 
                ||@Formula==5&&@Fourth_Dimension==1
  endheading
  
  heading
    caption="Plot:  z_j;  z_k;  z_real"
    visible=@Formula==0||@Formula==1||@Formula==2||@Formula==3||@Formula==4\ 
                ||@Formula==5&&@Fourth_Dimension==2
  endheading  

  
  heading
    caption="Plot:  z_j;  z_k;  z_imag"
    visible=@Formula==0||@Formula==1||@Formula==2||@Formula==3||@Formula==4\ 
                ||@Formula==5&&@Fourth_Dimension==3
  endheading  



  heading
    caption="Plot:  z_real;  z_imag;  c_real"
    visible=@Formula==10||@Formula==11&&@Fourth_Dim==0
  endheading
  
  heading
    caption="Plot:  z_real;  z_imag;  c_imag"
    visible=@Formula==10||@Formula==11&&@Fourth_Dim==1

  endheading
  
  heading
    caption="Plot:  c_real;  c_imag;  z_real"
    visible=@Formula==10||@Formula==11&&@Fourth_Dim==2
  endheading
  
  heading
    caption="Plot:  c_real;  c_imag;  z_imag"
    visible=@Formula==10||@Formula==11&&@Fourth_Dim==3
  endheading
  
  heading
    caption="Plot:  c_real;  c_imag;  c_j"
    visible=@Formula==6||@Formula==7||@Formula==8||@Formula==9&&@Fourth__Dim==0
  endheading
  
  heading
    caption="Plot:  c_real;  c_imag;  c_k"
    visible=@Formula==6||@Formula==7||@Formula==8||@Formula==9&&@Fourth__Dim==1
  endheading
  
  heading
    caption="Plot:  c_j;  c_k;  c_real"

    visible=@Formula==6||@Formula==7||@Formula==8||@Formula==9&&@Fourth__Dim==2
  endheading
  
  heading
    caption="Plot:  c_j;  c_k;  c_imag"
    visible=@Formula==6||@Formula==7||@Formula==8||@Formula==9&&@Fourth__Dim==3
  endheading
  
  heading

    caption="Basics"
  endheading
  
  param maxiter
    caption="Max Iterations"
    default=10
    hint="Maximum number of iterations"
  endparam
  
  param bailout
    caption="Bailout"
    default=4.0
    min=0.0
    hint="The bailout"
  endparam
  
  param precision
    caption="Precision"
    default=10
    min=1
    enabled=!@view
  endparam
  
  param Formula
    enum="Quaternion" "Hypernion" "Quaternion2" "Hypernion2" "Cubic Quaternion"\
               "Cubic Hypernion" "Quatbrot" "Hyperbrot" "Quatbrot2" "Hyperbrot2" \
               "Juliabrot" "Juliabrot2" "Cubic Parameterspace" "Quartic Parameterspace"
                
    default=0

    hint="Which Fractal formula that should be used."
  endparam
  
  
param Fourth__Dimension
  enum="b_imag" "b_real" "a_imag" "a_real"
  default=0
  hint="The fourth dimensional axis for Cubic Parameterspace"
  visible=@Formula==12
endparam



param Plotted_Space
  enum="a_real; a_imag; b_real" "a_real; a_imag; b_imag" "a_real; a_imag; c_real" "a_real; a_imag; c_imag" "b_real; b_imag; a_real" \
              "b_real; b_imag; a_imag" "b_real; b_imag; c_real" "b_real; b_imag; c_imag" "c_real; c_imag; a_real" "c_real; c_imag; a_imag" \
              "c_real; c_imag; b_real" "c_real; c_imag; b_imag" "a_real; b_real; c_real" "a_real; b_real; c_imag" "a_real; b_imag; c_real" \
              "a_real; b_imag; c_imag" "a_imag; b_real; c_real" "a_imag; b_real; c_imag" "a_imag; b_imag; c_real" "a_imag; b_imag; c_imag"
  default=0
  hint="The plotted planes for Quartic Parameterspace"
  visible=@Formula==13
endparam
  
  
  

  param Fourth_Dimension
    enum="Zk" "Zj" "Zi" "Zr"
    default=0
    hint="The fourth-dimension axis choosen from the fourdimensional \
               hypercomplex room (Zr,Zi,Zj,Zk)."
    visible=@Formula==0||@Formula==1||@Formula==2||@Formula==3||@Formula==4 \
            ||@Formula==5
  endparam
  

  param Fourth_Dim
    enum="C_imag" "C_real" "Z_imag" "Z_real"
    default=0

    hint="The fourth-dimension axis choosen from the fourdimensional complex room for \
               Juliabrots: (Zr,Zi) and (Cr,Ci)."
    visible=@Formula==10||@Formula==11
  endparam
  
  param Fourth__Dim
    enum="Ck" "Cj" "Ci" "Cr"
    default=0
    hint="The fourth-dimension axis choosen from the fourdimensional complex room for \
               Quatbrots and Hyperbrots(Cr,Ci,Cj,Ck)."
    visible=@Formula==6||@Formula==7||@Formula==8||@Formula==9
  endparam
  
  param view
    caption="2D"
    default=false
  endparam
  

  heading
    caption="Quaternions"
    visible=@Formula==0||@Formula==2||@Formula==4
  endheading

  heading
    caption="Hypernions"
    visible=@Formula==1||@Formula==3||@Formula==5
  endheading
  
  heading
    caption="Quatbrot - Initiation"
    visible=@Formula==6
  endheading
  
  
  heading
    caption="Hyperbrot - Initiation"
    visible=@Formula==7
  endheading
  
  
  heading
    caption="Quatbrot2 - Initiation"
    visible=@Formula==8
  endheading
  
  
  heading
    caption="Hyperbrot2 - Initiation"
    visible=@Formula==9
  endheading
  
  
  heading
    caption="Cubic Parameterspace - Initiation"
    visible=@Formula==12
  endheading
  
  param MSet
    enum="Union" "CCL" "M+" "M-"
    default=0
    hint="Initiation for Cubic Parameterspace."
    visible=@Formula==12
  endparam
  
  
  heading
    caption="Quartic Parameterspace - Initiation"
    visible=@Formula==13
  endheading
  
  param QMSet
    enum="Union" "QCL" "Ma" "Mb" "M(-a-b)" "Ma_&_Mb" "Ma_&_M(-a-b)" "Mb_&_M(-a-b)"
    default=0
    hint="Initiation for Quartic Parameterspace."
    visible=@Formula==13
  endparam
  
  
  param init_zri
    caption="Init Zri"
    default=(0,0)
    hint="Initiation for hypercomplex z in Quatbrot and Hyperbrot."
    visible=@Formula==6||@Formula==7
  endparam
  
    param init__zri
    caption="Init Zri"
    default=(0.5,0.0)
    hint="Initiation for hypercomplex z in Quatbrot2 and Hyperbrot2."
    visible=@Formula==8||@Formula==9
  endparam
  
  
  param init_zjk
    caption="Init Zjk"
    default=(0.0,0.0)
    hint="Initiation for hypercomplex z in Quatbrot and Hyperbrot."
    visible=@Formula==6||@Formula==7
  endparam
  
  param init__zjk
    caption="Init Zjk"
    default=(0.0,0.0)
    hint="Initiation for hypercomplex z in Quatbrot2 and Hyperbrot2."
    visible=@Formula==8||@Formula==9
  endparam
  
  
  param cri1
    caption="cri"
    default=(-0.7,0.0)
    hint="Input for Hypercomplex constants."
    visible=@Formula==0||@Formula==1
  endparam
  

  
  param cjk1
    caption="cjk"
    default=(0.0,0.0)
    hint="Input for Hypercomplex constants."
    visible=@Formula==0||@Formula==1
  endparam
  
  
    param cri2
    caption="cri"
    default=(-0.7,0.0)
    hint="Input for Hypercomplex constants."
    visible=@Formula==2||@Formula==3
  endparam
  
  
  param cjk2
    caption="cjk"
    default=(0.0,0.0)
    hint="Input for Hypercomplex constants."

    visible=@Formula==2||@Formula==3
  endparam

  
  
  param cri3
    caption="cri"
    default=(-0.7,0.0)
    hint="Input for Hypercomplex constants."
    visible=@Formula==4||@Formula==5
  endparam
  
  
  param cjk3
    caption="cjk"
    default=(0.0,0.0)
    hint="Input for Hypercomplex constants."
    visible=@Formula==4||@Formula==5
  endparam
  
  
  param bri
    caption="bri"
    default=(0.0,0.0)
    hint="Input for Cubic Hypercomplex constants."
    visible=@Formula==4||@Formula==5
  endparam
  
  
  param bjk
    caption="bjk"

    default=(0.0,0.0)
    hint="Input for Cubic Hypercomplex constants."
    visible=@Formula==4||@Formula==5
  endparam
  
  
  
  heading
    caption="Rotations"
  endheading
  
  
  param xrot
    caption="x_rotation"
    default=120.0

    hint="Rotates the x-axis (horizontal axis)."
  endparam
  
  param yrot
    caption="y_rotation"
    default=0.0
    hint="Rotates the y-axis (vertical axis)."
  endparam
  
  param zrot
    caption="z_rotation"
    default=30.0
    hint="Rotates the z-axis (depth axis)."
  endparam
  
  param localrot
    caption="Local Rotation"
    default=false
    hint="Rotates the coordinates locally. May give irritating while panning."
  endparam
  

  heading
    caption="Lightning"
    enabled=!@view
 endheading  
  
  param lightx
    caption="Light_X"
    default=4.0
    hint="Horizontal length of light-source"
    enabled=!@view
  endparam

  
  param lighty
    caption="Light_Y"
    default=4.0
    hint="Vertical length of light-source"
    enabled=!@view
  endparam
  
  param lightz
    caption="Light_Z"
    default=4.0
    hint="Depth length of light-source"
    enabled=!@view
  endparam


  
  heading
    caption="Inputs for Dimensions 4, 5 and 6"
    visible=@Formula==13
  endheading
  
  param a_real
    caption="a_real"
    default=0.0
    hint="Input for constant held dimension a_real ."
    visible=@Formula==13&&(@Plotted_Space==5||@Plotted_Space==6||@Plotted_Space==7|| \
                                                  @Plotted_Space==9||@Plotted_Space==10||@Plotted_Space==11|| \
                                                  @Plotted_Space==16||@Plotted_Space==17||@Plotted_Space==18|| \
                                                  @Plotted_Space==19)
  endparam
  
  param a_imag
    caption="a_imag"
    default=0.0
    hint="Input for constant held dimension a_imag ."
    visible=@Formula==13&&(@Plotted_Space==4||@Plotted_Space==6||@Plotted_Space==7|| \
                                                  @Plotted_Space==8||@Plotted_Space==10||@Plotted_Space==11|| \
                                                  @Plotted_Space==12||@Plotted_Space==13||@Plotted_Space==14|| \
                                                  @Plotted_Space==15)
  endparam
  
  param b_real
    caption="b_real"
    default=0.0
    hint="Input for constant held dimension b_real ."
    visible=@Formula==13&&(@Plotted_Space==1||@Plotted_Space==2||@Plotted_Space==3|| \
                                                  @Plotted_Space==8||@Plotted_Space==9||@Plotted_Space==11|| \
                                                  @Plotted_Space==14||@Plotted_Space==15||@Plotted_Space==18|| \
                                                  @Plotted_Space==19)
  endparam

  param b_imag
    caption="b_imag"
    default=0.0
    hint="Input for constant held dimension b_imag ."
    visible=@Formula==13&&(@Plotted_Space==0||@Plotted_Space==2||@Plotted_Space==3|| \
                                                  @Plotted_Space==8||@Plotted_Space==9||@Plotted_Space==10|| \
                                                  @Plotted_Space==12||@Plotted_Space==13||@Plotted_Space==16|| \
                                                  @Plotted_Space==17)
  endparam
  
  param c_real
    caption="c_real"
    default=0.0
    hint="Input for constant held dimension c_real ."
    visible=@Formula==13&&(@Plotted_Space==0||@Plotted_Space==1||@Plotted_Space==3|| \
                                                  @Plotted_Space==4||@Plotted_Space==5||@Plotted_Space==7|| \
                                                  @Plotted_Space==13||@Plotted_Space==15||@Plotted_Space==17|| \
                                                  @Plotted_Space==19)
  endparam
  
  param c_imag
    caption="c_imag"
    default=0.0
    hint="Input for constant held dimension c_imag ."
    visible=@Formula==13&&(@Plotted_Space==0||@Plotted_Space==1||@Plotted_Space==2|| \
                                                  @Plotted_Space==4||@Plotted_Space==5||@Plotted_Space==6|| \
                                                  @Plotted_Space==12||@Plotted_Space==14||@Plotted_Space==16|| \
                                                  @Plotted_Space==18)
  endparam

  
  heading
    caption="Environment"

  endheading

  param fourthdim
    caption="4-dim-center"
    default=0.0
    hint="Center on the fourth dimension axis."
    visible=@Formula!=13
  endparam
  
  param zcenter
    caption="3d-axis-center"
    default=0.0
    hint="Center of the depth-axis."
  endparam
  
  param zlength
    caption="3d-axis-length"
    default=4.0
    hint="Length of the depth-axis."
    enabled=!@view
  endparam
  
  param zpixels

    caption="Screen-depth"
    default=320
    hint="Length in pixels of depth-axis"
    enabled=!@view
  endparam
  
  param touchscreen
    caption="Screen-touch"
    default=false
    hint="Sets structures that cuts the screen to solid color. May be colored with inside coloring."
    enabled=!@view

  endparam
  
  
  heading
    caption="Coloring"
  endheading

param Coloring
  enum="None" "Raytrace2.ucl"
  default=0
  hint="Which coloring shall be used."
endparam

param Background
  enum="Solid" "Floating" "Inside"
  default=0
  hint="Multicolored or Onecolored background."
  enabled=!@view
endparam

param Gradient
  enum="One Gradient" "Two Gradients"
  default=0
  hint="In Two Gradients the gradient is divided in two equal parts."
  visible=@Formula!=12&&@Formula!=13
endparam

param Cubic_Gradient
  enum="One Gradient" "Two Gradients" "Three Gradients" "Four Gradients"
  default=0
  hint="In Two Gradients the gradient is divided in two equal parts. In Three Gradients - \
             three equal parts and in Four Gradients - four equal parts."
  visible=@Formula==12
endparam

param Quartic_Gradient
  enum="One Gradient" "Two Gradients" "Three Gradients" "Four Gradients"
  default=0
  hint="In Two Gradients the gradient is divided in two equal parts. In Three Gradients - \
             three equal parts and in Four Gradients - four equal parts."
  visible=@Formula==13
endparam
   
switch:
}


RayTrace {

;To use this module you will need the 
;coloring-algoritm Raytrace in spr.ucl

init:
  bool setflag=true
  bool tflag=false
  int iter=0
  int m=0
  int mm=0
  int rm=0
  int count2=0
  int ccount=0
  complex z=0
  complex rz=0
  complex z1=0
  complex zh=0
  complex cri=0
  complex cjk=0
  complex temp=0
  float a=0
  float b=0
  float c=0
  float d=0
  float ee=0
  float f=0
  float g=0
  float h=0
  float q=0
  float r=0
  float r2=0
  float r3=0
  float r4=0
  float r5=0
  float r6=0
  float r7=0
  float r8=0
  float ii=0
  float j=0
  float k=0
  float l=0
  float u=0
  float v=0
  float w=0
  float a1=0
  float b1=0
  float c1=0
  float d1=0
  float color1=-1.23456789e20
  float color2=1.23456789e20
  float temp0=0
  float lightdx=0
  float lightdy=0
  float lightdz=0
  float lightlength=0
  float flength=0
  float fx=0
  float fy=0
  float fz=0
  float tangle=0
  float buff0=0
  float buff1=0
  float buff2=0
  float buff3=0
  float buff4=0
  float rbuff0=0
  float rbuff1=0
  float rbuff2=0
  float rbuff3=0
  float rbuff4=0
  float diffx=0
  float diffy=0
  float count=0
  float count0=0
  float tangle=0
  float xx=0
  float yy=0
  float zz=0
  float ww=0
  float length=0.0
  float xscreen=real(#screenmax)
  float yscreen=imag(#screenmax)
  float zscreen=@zscreen
  float xmin=0
  float ymin=0
  float xmax=0
  float ymax=0
  if xscreen/yscreen>4/3
    temp0=3/#magn
    float temp0=-3/#magn
    ymin=imag(#center)-temp0/2
    ymax=ymin+temp0
    temp0=-xscreen/yscreen*temp0
    xmin=real(#center)-temp0/2
    xmax=xmin+temp0
  else
    temp0=4/#magn
    xmin=real(#center)-temp0/2
    xmax=xmin+temp0
    temp0=-yscreen/xscreen*temp0
    ymin=imag(#center)-temp0/2
    ymax=ymin+temp0
  endif
  float zmax=@zorig+@zdist/2
  float zmin=zmax-@zdist
  if @view==1
    zmax=@zorig
    zmin=@zorig

  endif
  if (@zmagn==true)&&(@view!=1)
    zmax=@zorig+@zdist/2/#magn
    zmin=zmax-@zdist/#magn
  endif
  if (@autoscale==true)&&(@view==0)
    zscreen=xscreen/(xmax-xmin)*(zmax-zmin)
  endif
  float dx=(xmax-xmin)/xscreen
  float dy=(ymax-ymin)/yscreen
  float dz=(zmax-zmin)/zscreen
  float origx=real(#center)
  float origy=imag(#center)
  float origz=@zorig
  float vx=@xrot/180.0*#pi
  float vy=@yrot/180.0*#pi
  float vz=@zrot/180.0*#pi
  float cosx=0
  float cosy=0
  float cosz=0
  float sinx=0
  float siny=0
  float sinz=0
  if @xrot==90.0
    sinx=1.0
    cosx=0
  elseif @xrot==-90
    sinx=-1.0
    cosx=0
  elseif abs(@xrot)==180
    sinx=0
    cosx=-1
  else
    cosx=cos(vx)
    sinx=sin(vx)
  endif
  if @yrot==90.0
    siny=1.0
    cosy=0
  elseif @yrot==-90
    siny=-1.0
    cosy=0
  elseif abs(@yrot)==180
    siny=0
    cosy=-1
  else
    cosy=cos(vy)
    siny=sin(vy)
  endif
  if @zrot==90.0
    sinz=1.0
    cosz=0
  elseif @zrot==-90
    sinz=-1.0
    cosz=0
  elseif abs(@zrot)==180
    sinz=0
    cosz=-1
  else
    cosz=cos(vz)
    sinz=sin(vz)
  endif
  float rminx=0
  float rminy=0
  float rminz=0
  float xy=0
  float xz=0
  float yx=0
  float yz=0
  float zx=0
  float zy=0
  float tempx=0
  float tempy=0
  float tempz=0
  float dxx=0
  float dxy=0
  float dxz=0
  float dyx=0
  float dyy=0
  float dyz=0
  float dzx=0
  float dzy=0
  float dzz=0
  float dzx=0
  float dzy=0
  float dzz=0
  float dzx1=0
  float dzy1=0
  float dzz1=0
; rotating the space and creation of unit-vectors
  xx=rminx=xmin
  yy=rminy=ymin
  zz=rminz=zmin
if @local==true
  xx=xx-origx
  yy=yy-origy
  zz=zz-origz
endif
  xy=yy*cosx-zz*sinx
  xz=yy*sinx+zz*cosx
  yy=xy
  zz=xz
  yx=xx*cosy+zz*siny
  yz=-xx*siny+zz*cosy
  xx=yx
  zz=yz
  zx=xx*cosz-yy*sinz
  zy=xx*sinz+yy*cosz
  xx=zx
  yy=zy

if @local==true
  xx=xx+origx
  yy=yy+origy
zz=zz+origz
  endif
  rminx=xx
  rminy=yy
  rminz=zz
  xx=tempx=xmax
  yy=tempy=ymin
  zz=tempz=zmin
if @local==true
  xx=xx-origx
  yy=yy-origy
  zz=zz-origz
endif
  xy=yy*cosx-zz*sinx
  xz=yy*sinx+zz*cosx
  yy=xy
  zz=xz
  yx=xx*cosy+zz*siny
  yz=-xx*siny+zz*cosy
  xx=yx
  zz=yz
  zx=xx*cosz-yy*sinz
  zy=xx*sinz+yy*cosz
  xx=zx
  yy=zy
if @local==true
  xx=xx+origx
  yy=yy+origy
  zz=zz+origz
endif
  tempx=xx
  tempy=yy
  tempz=zz
  dxx=(tempx-rminx)/xscreen
  dxy=(tempy-rminy)/xscreen
  dxz=(tempz-rminz)/xscreen
  xx=tempx=xmin
  yy=tempy=ymax
  zz=tempz=zmin
if @local==true
  xx=xx-origx
  yy=yy-origy
  zz=zz-origz
endif
  xy=yy*cosx-zz*sinx
  xz=yy*sinx+zz*cosx
  yy=xy
  zz=xz
  yx=xx*cosy+zz*siny
  yz=-xx*siny+zz*cosy
  xx=yx
  zz=yz
  zx=xx*cosz-yy*sinz
  zy=xx*sinz+yy*cosz
  xx=zx
  yy=zy
if @local==true
  xx=xx+origx
  yy=yy+origy
  zz=zz+origz
endif
  tempx=xx
  tempy=yy
  tempz=zz
  dyx=(tempx-rminx)/yscreen
  dyy=(tempy-rminy)/yscreen
  dyz=(tempz-rminz)/yscreen
  xx=tempx=xmin
  yy=tempy=ymin
  zz=tempz=zmax
if @local==true
  xx=xx-origx
  yy=yy-origy
  zz=zz-origz
endif
  xy=yy*cosx-zz*sinx
  xz=yy*sinx+zz*cosx
  yy=xy
  zz=xz
  yx=xx*cosy+zz*siny
  yz=-xx*siny+zz*cosy
  xx=yx
  zz=yz
  zx=xx*cosz-yy*sinz
  zy=xx*sinz+yy*cosz
  xx=zx
  yy=zy
if @local==true
  xx=xx+origx
  yy=yy+origy
  zz=zz+origz
endif
  tempx=xx
  tempy=yy
  tempz=zz
  dzx=(tempx-rminx)/zscreen
  dzy=(tempy-rminy)/zscreen
  dzz=(tempz-rminz)/zscreen
  dzx1=dzx/@prec
  dzy1=dzy/@prec
  dzz1=dzz/@prec
; end rotation and creating unit-vectors 'puuh'
if @formula==0
repeat 
  ccount=ccount+1
  if @zinit>1
    ccount=ccount+1
  endif
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        z1=xx+flip(yy)
        zh=zz+flip(ww)
        m=0
          if @zinit==1
            z=z1
          elseif @zinit==2
            z=-z1
          elseif @zinit==0&&ccount==1
            z=z1
          else
            z=-z1
          endif
        repeat
          z=z*z*z-3*z1*z1*z+zh
          length=|z|
          m=m+1
        until m>=#maxiter || length>=@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          z1=xx+flip(yy)
          zh=zz+flip(ww)
          if @zinit==1
            z=z1
          elseif @zinit==2
            z=-z1
          elseif @zinit==0&&ccount==1
            z=z1
          else
            z=-z1
          endif
          repeat
            z=z*z*z-3*z1*z1*z+zh
            length=|z|
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  if @zinit==0&&ccount==1
    rbuff0=buff0
    rbuff1=buff1
    rbuff2=buff2
    rbuff3=buff3
    rbuff4=buff4
    rz=z
    rm=mm
  endif
until ccount==2
  if@zinit==0
    if @view>0
      if mm<rm
        mm=rm
      endif
    elseif rbuff0<buff0&&@view==0
      buff0=rbuff0
      buff1=rbuff1
      buff2=rbuff2
      buff3=rbuff3
      buff4=rbuff4
      z=rz
      mm=rm
    else 
      color1=-2.23456789e20
    endif
  endif
elseif @formula==1   
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        z1=xx+flip(yy)
        zh=zz+flip(ww)
        m=0
        z=z1
        repeat
          z=z*z+zh
          length=|z|
          m=m+1
        until m>=#maxiter || length>=@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          z1=xx+flip(yy)
          zh=zz+flip(ww)
          z=z1
          repeat
            z=z*z+zh
            length=|z|
            m=m+1

          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
elseif @formula==2
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        z1=xx+flip(yy)
        zh=zz+flip(ww)
        cri=@cr+flip(@ci)
        cjk=@cj+flip(@ck)
        m=0
        repeat
          temp=z1*z1-real(zh)^2-imag(zh)^2+cri
          zh=2*(real(z1)*real(zh)+flip(real(z1)*imag(zh)))+cjk
          z1=temp
          length=|z1|+|zh|
          m=m+1
        until m>=#maxiter || length>=@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          z1=xx+flip(yy)
          zh=zz+flip(ww)
          cri=@cr+flip(@ci)
          cjk=@cj+flip(@ck)
          repeat
            temp=z1*z1-real(zh)^2-imag(zh)^2+cri
            zh=2*(real(z1)*real(zh)+flip(real(z1)*imag(zh)))+cjk
            z1=temp
            length=|z1|+|zh|
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=z1
elseif @formula==3
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        z1=xx+flip(yy)
        zh=zz+flip(ww)
        cri=@cr+flip(@ci)
        cjk=@cj+flip(@ck)
        m=0
        repeat
        ; 1st hyp
        temp=z1*z1-real(zh)^2+imag(zh)^2-2*flip(real(zh)*imag(zh))+cri
        zh=2*(real(z1)*real(zh)-imag(z1)*imag(zh)+flip(real(z1)*imag(zh)+imag(z1)*real(zh)))+cjk
          z1=temp
          length=|z1|+|zh|
          m=m+1
        until m>=#maxiter || length>=@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          z1=xx+flip(yy)
          zh=zz+flip(ww)
          cri=@cr+flip(@ci)
          cjk=@cj+flip(@ck)
          repeat                    
            temp=z1*z1-real(zh)^2+imag(zh)^2-2*flip(real(zh)*imag(zh))+cri
        zh=2*(real(z1)*real(zh)-imag(z1)*imag(zh)+flip(real(z1)*imag(zh)+imag(z1)*real(zh)))+cjk
            z1=temp
            length=|z1|+|zh|
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=z1
elseif @formula==4
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        z1=@cr+flip(@ci)
        zh=@cj+flip(@ck)
        cri=xx+flip(yy)
        cjk=zz+flip(ww)
        m=0
        repeat
          temp=z1*z1-real(zh)^2-imag(zh)^2+cri
          zh=2*(real(z1)*real(zh)+flip(real(z1)*imag(zh)))+cjk
          z1=temp
          length=|z1|+|zh|
          m=m+1

        until m>=#maxiter || length>=@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          z1=@cr+flip(@ci)
          zh=@cj+flip(@ck)
          cri=xx+flip(yy)
          cjk=zz+flip(ww)
          repeat
            temp=z1*z1-real(zh)^2-imag(zh)^2+cri
            zh=2*(real(z1)*real(zh)+flip(real(z1)*imag(zh)))+cjk
            z1=temp
            length=|z1|+|zh|
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout

        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=z1
elseif @formula==5
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx

        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        z1=@cr+flip(@ci)
        zh=@cj+flip(@ck)
        cri=xx+flip(yy)
        cjk=zz+flip(ww)
        m=0
        repeat
        temp=z1*z1-real(zh)^2+imag(zh)^2-2*flip(real(zh)*imag(zh))+cri
        zh=2*(real(z1)*real(zh)-imag(z1)*imag(zh)+flip(real(z1)*imag(zh)+imag(z1)*real(zh)))+cjk
          z1=temp
          length=|z1|+|zh|
          m=m+1
        until m>=#maxiter || length>=@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          z1=@cr+flip(@ci)
          zh=@cj+flip(@ck)
          cri=xx+flip(yy)
          cjk=zz+flip(ww)
          repeat                

            temp=z1*z1-real(zh)^2+imag(zh)^2-2*flip(real(zh)*imag(zh))+cri
        zh=2*(real(z1)*real(zh)-imag(z1)*imag(zh)+flip(real(z1)*imag(zh)+imag(z1)*real(zh)))+cjk
            z1=temp
            length=|z1|+|zh|
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6


        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=z1
elseif @formula==6
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        z1=xx+flip(yy)
        zh=zz+flip(ww)
        m=0
        z=z1
        repeat
          z=zh*z*(1-z)
          length=|z|
          m=m+1
        until m>=#maxiter || length>=@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          z1=xx+flip(yy)
          zh=zz+flip(ww)
          z=z1
          repeat
            z=zh*z*(1-z)
            length=|z|
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5

elseif @formula==7
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2

      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0

      repeat

        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        m=0
        a=xx
        b=yy
        c=zz
        d=ww
        ee=@cr
        f=@ci
        g=@cj
        h=@ck
        repeat
          q=a-(a*a-b*b-c*c-d*d)
          r=1-2*a
          l=-f*b-g*c-h*d
          u=ee*b+g*d-h*c
          v=ee*c+h*b-f*d
          w=ee*d+f*c-g*b
          a=ee*q+l*r
          b=f*q+u*r
          c=g*q+v*r
          d=h*q+w*r 
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          a=xx
          b=yy
          c=zz
          d=ww
          ee=@cr
          f=@ci
          g=@cj
          h=@ck
          repeat
            q=a-(a*a-b*b-c*c-d*d)
            r=1-2*a

            l=-f*b-g*c-h*d
            u=ee*b+g*d-h*c
            v=ee*c+h*b-f*d
            w=ee*d+f*c-g*b
            a=ee*q+l*r
            b=f*q+u*r
            c=g*q+v*r
            d=h*q+w*r 

            length=a*a+b*b+c*c+d*d
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=a+flip(b)
elseif @formula==8
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        m=0
        a=xx
        b=yy
        c=zz
        d=ww
        ee=@cr
        f=@ci
        g=@cj
        h=@ck
        repeat
          q=a*a-b*b-c*c+d*d
          u=c*d-a*b
          v=b*d-a*c
          w=a*d+b*c
          a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))
          b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
          c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
          d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
          a=a1
          b=b1
          c=c1
          d=d1
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif

          m=0
          a=xx
          b=yy
          c=zz
          d=ww

          ee=@cr

          f=@ci
          g=@cj
          h=@ck
          repeat
            q=a*a-b*b-c*c+d*d
            u=c*d-a*b
            v=b*d-a*c
            w=a*d+b*c
            a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))
            b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
            c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
            d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
            a=a1
            b=b1
            c=c1
            d=d1
            length=a*a+b*b+c*c+d*d
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=a+flip(b)
elseif @formula==9
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        m=0
        a=@cr
        b=@ci
        c=@cj
        d=@ck
        ee=xx
        f=yy
        g=zz
        h=ww
        repeat
          q=a-(a*a-b*b-c*c-d*d)

          r=1-2*a
          l=-f*b-g*c-h*d
          u=ee*b+g*d-h*c
          v=ee*c+h*b-f*d
          w=ee*d+f*c-g*b
          a=ee*q+l*r
          b=f*q+u*r
          c=g*q+v*r
          d=h*q+w*r 
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1

            yy=yy-dzy1

            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          a=@cr
          b=@ci
          c=@cj
          d=@ck
          ee=xx
          f=yy
          g=zz
          h=ww
          repeat
            q=a-(a*a-b*b-c*c-d*d)
            r=1-2*a
            l=-f*b-g*c-h*d
            u=ee*b+g*d-h*c
            v=ee*c+h*b-f*d
            w=ee*d+f*c-g*b
            a=ee*q+l*r
            b=f*q+u*r
            c=g*q+v*r
            d=h*q+w*r 
            length=a*a+b*b+c*c+d*d
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=a+flip(b)
elseif @formula==10

  count0=0
  repeat

    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        m=0
        a=@cr
        b=@ci
        c=@cj
        d=@ck
        ee=xx
        f=yy
        g=zz
        h=ww
        repeat
          q=a*a-b*b-c*c+d*d
          u=c*d-a*b
          v=b*d-a*c
          w=a*d+b*c
          a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))
          b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
          c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
          d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
          a=a1
          b=b1
          c=c1
          d=d1
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
          m=0
          a=@cr
          b=@ci
          c=@cj
          d=@ck
          ee=xx
          f=yy
          g=zz
          h=ww
          repeat
            q=a*a-b*b-c*c+d*d
            u=c*d-a*b
            v=b*d-a*c
            w=a*d+b*c
            a1=a*ee-b*f-c*g+d*h-(ee*q+2*(f*u+g*v+h*w))
            b1=a*f+b*ee-c*h-d*g-(f*q+2*(-ee*u+h*v-g*w))
            c1=a*g-b*h+c*ee-d*f-(g*q+2*(h*u-ee*v-f*w))
            d1=a*h+b*g+c*f+d*ee-(h*q+2*(-g*u-f*v+ee*w))
            a=a1
            b=b1
            c=c1
            d=d1
            length=a*a+b*b+c*c+d*d
            m=m+1
          until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec

        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec

        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=a+flip(b)
elseif @formula==11
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif
      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz
        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        m=0
        a=xx
        b=yy
        c=zz
        d=ww
        ee=@cr
        f=@ci
        g=@cj
        h=@ck
        ii=@br
        j=@bi
        k=@bj
        l=@bk
        repeat
          u=3*a*a-b*b-c*c-d*d
          v=3*(ee*ee-f*f-g*g-h*h)

          w=6*ee
          q=u-v
          a1=a*(3*u-8*a*a-v)+w*(f*b+g*c+h*d)+ii
          b1=b*q-w*(f*a+g*d-h*c)+j
          c1=c*q-w*(-f*d+g*a+h*b)+k
          d1=d*q-w*(f*c-g*b+h*a)+l
          a=a1
          b=b1
          c=c1
          d=d1 
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
        m=0
        a=xx
        b=yy
        c=zz
        d=ww
        ee=@cr
        f=@ci
        g=@cj
        h=@ck
        ii=@br
        j=@bi
        k=@bj
        l=@bk
        repeat
          u=3*a*a-b*b-c*c-d*d
          v=3*(ee*ee-f*f-g*g-h*h)
          w=6*ee
          q=u-v
          a1=a*(3*u-8*a*a-v)+w*(f*b+g*c+h*d)+ii
          b1=b*q-w*(f*a+g*d-h*c)+j
          c1=c*q-w*(-f*d+g*a+h*b)+k
          d1=d*q-w*(f*c-g*b+h*a)+l
          a=a1
          b=b1
          c=c1
          d=d1 
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout
          count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec

        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=a+flip(b)
elseif @formula==12
  count0=0
  repeat
    diffx=0
    diffy=0
    if count0==1
      diffx=-@delta
    elseif count0==2
      diffx=@delta
    elseif count0==3
      diffy=@delta
    elseif count0==4
      diffy=-@delta
    endif
    tempx=rminx+(real(#screenpixel)+diffx)*dxx+(imag(#screenpixel)+diffy)*dyx
    tempy=rminy+(real(#screenpixel)+diffx)*dxy+(imag(#screenpixel)+diffy)*dyy
    tempz=rminz+(real(#screenpixel)+diffx)*dxz+(imag(#screenpixel)+diffy)*dyz
      if @fourthdim==3
        xx=tempx
        yy=tempy
        zz=tempz
        ww=@fourthvalue
      elseif @fourthdim==2
        xx=tempx
        yy=tempy
        zz=@fourthvalue
        ww=tempz
      elseif @fourthdim==1
        xx=tempz
        yy=@fourthvalue
        zz=tempx
        ww=tempy
      else
        xx=@fourthvalue
        yy=tempz
        zz=tempx
        ww=tempy
      endif

      count=0.0
      repeat
        if @fourthdim==3
          xx=xx+dzx
          yy=yy+dzy
          zz=zz+dzz
        elseif @fourthdim==2
          xx=xx+dzx
          yy=yy+dzy
          ww=ww+dzz

        elseif @fourthdim==1
          xx=xx+dzz
          zz=zz+dzx
          ww=ww+dzy
        else
          yy=yy+dzz
          zz=zz+dzx
          ww=ww+dzy
        endif
        m=0
        a=xx
        b=yy
        c=zz
        d=ww
        ee=@cr
        f=@ci
        g=@cj
        h=@ck
        ii=@br
        j=@bi
        k=@bj
        l=@bk
        repeat
          r5=a*a
          r6=b*b
          r7=c*c
          r8=d*d
          u=ee*ee-f*f-g*g+h*h
          v=g*h-ee*f
          w=f*h-ee*g
          q=ee*h+f*g
          r=-r7+r8
          r2=r5-r6
          r3=6*c*d
          r4=6*a*b
          a1=r5*a+3*a*(-r6+r)+b*r3-3*(a*u+2*(b*v+c*w+d*q))+ii
          b1=-r6*b+3*b*(r5+r)-a*r3-3*(b*u+2*(-a*v+d*w-c*q))+j
          c1=-r7*c+3*c*(r2+r8)-r4*d-3*(c*u+2*(d*v-a*w-b*q))+k
          d1=r8*d+3*d*(r2-r7)+r4*c-3*(d*u+2*(-c*v-b*w+a*q))+l
          a=a1
          b=b1
          c=c1
          d=d1 
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout ;hr
        mm=m
        count=count+1
      until (count>=zscreen || length<@bailout)||(@view>0)
      if count==1
        if m>=#maxiter&&@view==0&&@touchscreen==true
          tflag=true
        endif
      endif
      if @view>0
        count0=6
      elseif (length<@bailout)&&(count>1)
        count2=0
        repeat
          if @fourthdim==3
            xx=xx-dzx1
            yy=yy-dzy1
            zz=zz-dzz1
          elseif @fourthdim==2
            xx=xx-dzx1
            yy=yy-dzy1
            ww=ww-dzz1
          elseif @fourthdim==1
            xx=xx-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          else
            yy=yy-dzz1
            zz=zz-dzx1
            ww=ww-dzy1
          endif
        m=0
        a=xx
        b=yy
        c=zz
        d=ww
        ee=@cr
        f=@ci
        g=@cj
        h=@ck
        ii=@br
        j=@bi
        k=@bj
        l=@bk
        repeat
          r5=a*a
          r6=b*b
          r7=c*c
          r8=d*d

          u=ee*ee-f*f-g*g+h*h
          v=g*h-ee*f
          w=f*h-ee*g
          q=ee*h+f*g
          r=-r7+r8
          r2=r5-r6
          r3=6*c*d
          r4=6*a*b
          a1=r5*a+3*a*(-r6+r)+b*r3-3*(a*u+2*(b*v+c*w+d*q))+ii
          b1=-r6*b+3*b*(r5+r)-a*r3-3*(b*u+2*(-a*v+d*w-c*q))+j
          c1=-r7*c+3*c*(r2+r8)-r4*d-3*(c*u+2*(d*v-a*w-b*q))+k
          d1=r8*d+3*d*(r2-r7)+r4*c-3*(d*u+2*(-c*v-b*w+a*q))+l
          a=a1
          b=b1
          c=c1
          d=d1 
          length=a*a+b*b+c*c+d*d
          m=m+1
        until m>=#maxiter || length>@bailout
        count2=count2+1
        until length>=@bailout
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      elseif count==1
        if count0==0
          buff0=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==1
          buff1=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==2
          buff2=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==3
          buff3=zmin+count*dz-(count2-1)*dz/@prec
        elseif count0==4
          buff4=zmin+count*dz-(count2-1)*dz/@prec
        endif
      else
        if count0==0
          buff0=zmax+dz
          count0=6
        elseif count0==1
          buff1=zmax+dz
        elseif count0==2
          buff2=zmax+dz
        elseif count0==3
          buff3=zmax+dz
        elseif count0==4
          buff4=zmax+dz
        endif
      endif
    count0=count0+1
  until count0>=5
  z=a+flip(b)

endif
; tracing
  if @view>0
    setflag=false
  elseif buff0>zmax&&@background>0
    setflag=false
  else
    lightdx=real(#screenpixel)*dx+xmin-@lightx
    lightdy=imag(#screenpixel)*dy+ymin-@lighty
    lightdz=buff0-@lightz
    lightlength=sqrt(lightdx*lightdx+lightdy*lightdy+lightdz*lightdz)
    fx=(buff2-buff1)*2*dy
    fy=-2*dx*(buff4-buff3)
    fz=-4*dx*dy
    flength=sqrt(fx*fx+fy*fy+fz*fz)
    tangle=(fx*lightdx+fy*lightdy+fz*lightdz)/(flength*lightlength)
  endif
  if tflag==true&&@view==0
    setflag=false
  endif
  
loop:
  if @view>0
    iter=iter+1
  elseif buff0>zmax
    if @background==0
      z=tangle+flip(color2)
    elseif @background==1
      setflag=false
    endif
  elseif tflag==true
    setflag=false
  else
    z=tangle+flip(color1)
  endif
bailout:
  (setflag==false&&@view==0)|| \
  (iter<mm+1&&@view>0)
  
default:
  title = "RayTrace"
  method=guessing
  periodicity=0
  maxiter=10
  
  param formula
    enum="Cubic" "Juliabrot" "Quaternion" "Hypernion" "Quatbrot" "Hyperbrot" "Juliabrot 2" \
         "Quaternion 2" "Hypernion 2"  "Quatbrot 2" "Hyperbrot 2" "Cubic Quat" "Cubic Hyper"
    default=0
    hint="type of formula for raytracing."
  endparam
  
  param fourthdim
    enum="a-real or zr" "a-imag or zi" "b-real or zj" "b-imag or zk"
    default=3
    hint=" axis that points into the fourth dimension. Cubic or Quaternion-Hypercomplex."
  endparam
  
  param fourthvalue
    caption="4-dim-value"
    default=0.0
    hint="value for the fourth axis."
  endparam
  
    
  param zorig
    caption="z-center"
    default=0.0
    hint="Center of z-axis."
  endparam
  
  param zinit
    enum="Both" "a" "-a"
    default=0
    hint="Initial values for Cubic"
  endparam
  
  param view
    enum="3-dim" "2-dim-center" "2-dim-screen"
    default=0
    hint="View-system. 3d or 2d from center or 2d from 'screentouch'."
  endparam
  
  param background
    enum="outside" "inside"

    default=0
    hint="What type of background-coloring you want. With inside only one colour or inside \
          coloring filter"
  endparam
  
  param touchscreen
    caption="Screen-touch"
    default=false
    hint="Those structures that goes out of the screen, or touches it, is colored with \
          inside colouring."
  endparam
    
  param cr
    caption="cr"
    default=0.0
    hint="real constant for quaternions and hypercomplex calculations. In cubic quaternions \
          this corresponds to a-real."
  endparam
  
  param ci
    caption="ci"
    default=0.0
    hint="imaginary constant for quaternions and hypercomplex calculations. In cubic \
          quaternions this corresponds to a-imag."
  endparam
  
  param cj
    caption="cj"
    default=0.0
    hint="Second imaginary constant for quaternions and hypercomplex calculations.  In cubic \
          quaternions this corresponds to a-jmag."
  endparam
  
  param ck
    caption="ck"
    default=0.0
    hint="Third imaginary constant for quaternions and hypercomplex calculations.  In cubic \
          quaternions this corresponds to a-kmag."
  endparam
  
  param br
    caption="br"
    default=0.0
    hint="real constant for cubic quaternions and cubic hypercomplex calculations. \
          Corresponds to b-real."
  endparam
  
  param bi
    caption="bi"
    default=0.0
    hint="imaginary constant for cubic quaternions and cubic hypercomplex calculations. \
          Corresponds to b-imag."
  endparam

  param bj
    caption="bj"
    default=0.0
    hint="second imaginary constant for cubic quaternions and hypercomplex calculations. \
          Corresponds to b-jmag."
  endparam

  param bk
    caption="bk"
    default=0.0
    hint="third imaginary constant for cubic quaternions and hypercomplex calculations. \
          Corresponds to b-kmag."
  endparam
  
  param xrot
    caption="x-rotation"
    default=0.0
    hint="Rotates the system through the x-axis."
  endparam
  
  param yrot
    caption="y-rotation"
    default=0.0
    hint="Rotates the system through the y-axis."
  endparam
  
  param zrot
    caption="z-rotation"
    default=0.0
    hint="Rotates the system through the z-axis."
  endparam
  
  param local
    caption="Local rotation"
    default=true
    hint="Sets local rotation. Otherwise location around zero."
  endparam
  
  param lightx
    caption="Light-x"
    default=0.0
    hint="x-coord of lightsource"
  endparam
  
  param lighty
    caption="Light-y"
    default=0.0
    hint="y-coord of lightsource"
  endparam
  
  param lightz
    caption="Light-z"
    default=-6.0
    hint="z-coord of lightsource"
  endparam
  
  param zscreen
    caption="Screen-depth"
    default=320.0
    hint="Screendepth in virtual pixels."
    min=0
  endparam
  
  param zdist
    caption="z-distance"
    default=4.0
    hint="Length of z-axis."
  endparam
  
  param zmagn
    caption="z-magnify"
    default=false
    hint="If set then the fractal will be magnified in the third dimension too."
  endparam
  
  param autoscale
    caption="Auto scaling"
    default=false
    hint="If set then the screendepth in virtual pixels will be set to hold the same scalar \
          proportions as the x-axis. Take it easy with this as you dont have to \
          magnify the screensurface very much to get a very long z-axis in pixels. If \
          z-magnify is set too then there is no danger in overproportions."
  endparam
  
  param prec
    caption="Precision"
    default=10.0
    min=1.0
    hint="Precision for the fine tracing. The lower, the faster but with less precision. \
          Smallest value allowed is 1.0"
  endparam
  
  param delta
    caption="Delta"
    default=1.0
    hint="The difference between the points that builds the normal-plane to the lightsource. \
          Should normally be 1.0"
  endparam
    
  
  param bailout
    caption="Bailout"
    default=4.0
    hint="Breakvalue for iterations."
    min=0.0
  endparam
}

MToJ {
init:
  complex z=0
  if @zinit!=0
    z=@zinit
  else
    if @formula==1
      z=0.5
    endif
  endif
loop:
  if @formula==0
    z=z^2+#pixel
  else
    z=#pixel*z*(1-z)

  endif

bailout:
  |z|<@bailout
switch:
  type="BackToM"
  seed=#pixel
  formula=formula
  bailout=bailout

  
default:
  title = "MToJ"
  
  param formula
    enum="z->z^2+c" "z->cz(1-z)"
    default=0
    hint="z->z^2+c is the Mandelbrot."
  endparam
  
  param zinit
    caption="z-init"
    default=(0,0)
  endparam
  
  param bailout
    caption="bailout"
    default=4.0
  endparam
}


BackToM{
init:
  complex z=#pixel
loop:
  if @formula==0
    z=z^2+@seed
  else
    z=@seed*z*(1-z)
  endif
bailout:
  |z|<@bailout
switch:
  type="MToJ"
  bailout=bailout
  formula=formula
  
default:
  title = "BackToM"
  periodicity=0
  
  param formula
    enum="z->z^2+c" "z->cz(1-z)"
    default=0
    hint="z->z^2+c is the Mandelbrot."
  endparam
  
  param seed
    caption="seed"
    default=(-0.4875,0.5875)
  endparam
  
  param bailout
    caption="bailout"
    default=4.0
  endparam
}


IPol {
init:
  complex z=@zinit
  complex zold=0
loop:
  zold=z
  z=@fu3(1/@fu2(1+@fu1(zold^@n1))^@n2)+@pixfu(#pixel)
bailout:
  ((@diffbail==false)&&(|z|<@bailout))|| \
  ((@diffbail==true)&&(|z-zold|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="IPolJulia"
  seed=#pixel
  fu1=fu1
  fu2=fu2
  fu3=fu3
  pixfu=pixfu
  bailout=bailout
  diffbail=diffbail
  zinit=zinit
  n1=n1
  n2=n2
  
default:
  title = "IPol"
  periodicity=0
  method=multipass
  angle=90.0
  
  func fu1
    caption="1/(1+f1(z))"
    default=ident()
  endfunc
  
  func fu2
    caption="1/f2(1+z)"
    default=abs()
  endfunc
  
  func fu3
    caption="f3(1/(1+z))"
    default=ident()
  endfunc
  
  func pixfu
    caption="Pix-func"
    default=ident()
  endfunc
  
  param n1
    caption="z^n1"
    default=(1,0)
  endparam
  
  param n2
    caption="1/(1+z)^n2"
    default=(2,0)
  endparam
  
  param zinit
    caption="z-init"
    default=(0,0)
  endparam
  
  param diffbail
    caption="diff-bailout"
    default=false
  endparam
  
  param bailout

    caption="bailout"
    default=2.0
  endparam
}



IPolJulia {
init:
  complex z=#pixel
  complex zold=0
loop:
  zold=z
  z=@fu3(1/@fu2(1+@fu1(zold^@n1))^@n2)+@pixfu(@seed)
bailout:
  ((@diffbail==false)&&(|z|<@bailout))|| \
  ((@diffbail==true)&&(|z-zold|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="IPol"
  fu1=fu1
  fu2=fu2
  fu3=fu3
  pixfu=pixfu
  bailout=bailout
  diffbail=diffbail
  zinit=zinit
  n1=n1
  n2=n2
  
default:
  title = "IPolJulia"
  periodicity=0
  method=multipass
  angle=90.0
  
  func fu1
    caption="1/(1+f1(z))"
    default=ident()
  endfunc
  
  func fu2
    caption="1/f2(1+z)"
    default=abs()
  endfunc
  
  func fu3
    caption="f3(1/(1+z))"
    default=ident()
  endfunc
  
  func pixfu
    caption="Pix-func"
    default=ident()
  endfunc
  
  param seed
    caption="seed"
    default=(-0.375,0.8)
  endparam
  
  param n1
    caption="z^n1"
    default=(1,0)
  endparam
  
  param n2
    caption="1/(1+z)^n2"
    default=(2,0)
  endparam
  
  param diffbail
    caption="diff-bailout"
    default=false
  endparam
  
  param bailout
    caption="bailout"
    default=2.0
  endparam
  

  param zinit
    caption="z-init"
    default=(0,0)
  endparam
}


IPol2 {
init:
  complex z=@zinit
  complex zold=0
loop:
  zold=z
  z=@fu3(@fu0(zold^@n0)/@fu2(1+@fu1(zold^@n1))^@n2)+@pixfu(#pixel)
bailout:
  ((@diffbail==false)&&(|z|<@bailout))|| \
  ((@diffbail==true)&&(|z-zold|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="IPol2Julia"
  seed=#pixel
  fu0=fu0
  fu1=fu1
  fu2=fu2
  fu3=fu3
  pixfu=pixfu
  bailout=bailout
  diffbail=diffbail
  zinit=zinit
  n0=n0
  n1=n1
  n2=n2
  
default:
  title = "IPol2"
  periodicity=0
  method=multipass
  angle=90.0
  
  func fu0
    caption="f0(z)/(1+z)"
    default=ident()
  endfunc
  
  func fu1
    caption="z/(1+f1(z))"
    default=ident()
  endfunc
  
  func fu2
    caption="z/f2(1+z)"
    default=ident()
  endfunc
  
  func fu3
    caption="f3(z/(1+z))"
    default=ident()
  endfunc
  
  func pixfu
    caption="Pix-func"
    default=ident()
  endfunc
  
  param n0
    caption="z^n0/(1+z)"
    default=(2,0)
  endparam
  
  param n1
    caption="z/(1+z^n1)"
    default=(1,0)
  endparam
  
  param n2
    caption="z/(1+z)^n2"
    default=(1,0)
  endparam
  
  param zinit
    caption="z-init"
    default=(0,0)
  endparam
  
  param diffbail
    caption="diff-bailout"
    default=true
  endparam
  
  param bailout
    caption="bailout"
    default=100.0
  endparam
}



IPol2Julia {
init:
  complex z=#pixel
  complex zold=0
loop:
  zold=z
  z=@fu3(@fu0(zold^@n0)/@fu2(1+@fu1(zold^@n1))^@n2)+@pixfu(@seed)
bailout:
  ((@diffbail==false)&&(|z|<@bailout))|| \
  ((@diffbail==true)&&(|z-zold|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="IPol2"
  fu0=fu0
  fu1=fu1
  fu2=fu2
  fu3=fu3
  pixfu=pixfu
  bailout=bailout
  diffbail=diffbail
  zinit=zinit
  n0=n0
  n1=n1
  n2=n2
  
default:
  title = "IPol2Julia"
  periodicity=0
  method=multipass
  angle=90.0
  
  func fu0
    caption="f0(z)/(1+z)"
    default=ident()
  endfunc
  
  func fu1
    caption="z/(1+f1(z))"
    default=ident()
  endfunc
  
  func fu2
    caption="z/f2(1+z)"
    default=ident()
  endfunc
  
  func fu3
    caption="f3(z/(1+z))"
    default=abs()
  endfunc
  
  func pixfu
    caption="Pix-func"
    default=ident()
  endfunc
  
  param seed
    caption="seed"
    default=(-0.7,-0.65)
  endparam
  
  param n0
    caption="z^n0/(1+z)"
    default=(3,0)
  endparam
  
  param n1
    caption="z/(1+z^n1)"
    default=(2,0)
  endparam
  
  param n2
    caption="z/(1+z)^n2"
    default=(1,0)
  endparam
  
  param diffbail
    caption="diff-bailout"
    default=true
  endparam
  
  param bailout
    caption="bailout"
    default=100.0
  endparam
  
  param zinit
    caption="z-init"
    default=(0,0)
  endparam
}



IPolNewton {
init:

  complex zold=0
  complex t=0
  complex u=0
  complex v=0
  int i=0
  if @init==1
    complex z=@zinit
  elseif @init==2
    complex z=#pixel
  else
    complex z=@zinit
    if @formula==0
      repeat
        zold=z
        if zold==0
          zold=1e-20
        endif
        t=zold^@n1
        u=zold^@n0
        z=zold-(u-@r*(1+t)^@n2)/(u/zold*(@n0-@n2*@n1*t/(1+t)))
        i=i+1
      until (i>29)||(|z-zold|<@bailout)
      if i>29
        z=@zinit
      endif
    elseif @formula==1
      repeat
        zold=z
        if zold==0
          zold=1e-20
        endif
        t=zold^@n1
        u=zold^@n0
        v=1+sin(t)
        z=zold-(sinh(u/v^@n2)-@r)/(cosh(u/zold*(@n0-@n2*@n1*zold*cos(t)/v)/v^@n2))
        i=i+1
      until (i>29)||(|z-zold|<@bailout)
      if i>29
        z=@zinit
      endif
    elseif @formula==2
      repeat
        zold=z
        if zold==0
          zold=1e-20
        endif
        t=zold^@n1
        u=zold^@n0
        v=log(u)
        z=zold-(v-@r*(1+sin(t))^@n2)/(@n0/zold-(@n1*@n2*t/zold*v*cos(t))/(1+sin(t))^@n2)
        i=i+1
      until (i>29)||(|z-zold|<@bailout)
      if i>29
        z=@zinit
      endif
    elseif @formula==3
      repeat
        zold=z
        if zold==0
          zold=1e-20
        endif
        t=zold^@n1
        u=zold^@n0
        v=1+log(t)
        z=zold-(sin(u)-@r*v^@n2)/(@n0*u/zold*cos(u)-(@n1*@n2/zold*sin(u)/v))
        i=i+1
      until (i>29)||(|z-zold|<@bailout)
      if i>29
        z=@zinit
      endif
    endif
  endif




loop:
  zold=z
  if zold==0
    zold=1e-20
  endif
  if @formula==0
    t=zold^@n1
    u=zold^@n0
    z=zold-(u-@r*(1+t)^@n2)/(u/zold*(@n0-@n2*@n1*t/(1+t)))+@pixfu(#pixel)
  elseif @formula==1
    t=zold^@n1
    u=zold^@n0
    v=1+sin(t)
    z=zold-(sinh(u/v^@n2)-@r)/(cosh(u/zold*(@n0-@n2*@n1*zold*cos(t)/v)/v^@n2))+@pixfu(#pixel)
  elseif @formula==2
    t=zold^@n1
    u=zold^@n0
    v=log(u)
    z=zold-(v-@r*(1+sin(t))^@n2)/(@n0/zold-(@n1*@n2*t/zold*v*cos(t))/(1+sin(t))^@n2) \
      +@pixfu(#pixel)
  elseif @formula==3
    t=zold^@n1
    u=zold^@n0
    v=1+log(t)
    z=zold-(sin(u)-@r*v^@n2)/(@n0*u/zold*cos(u)-(@n1*@n2/zold*sin(u)/v))+@pixfu(#pixel)
  endif
bailout:
|z-zold|>@bailout
  
switch:
  type="IPolNewtonJulia"
  seed=#pixel
  pixfu=pixfu
  bailout=bailout
  init=init
  zinit=zinit
  n0=n0
  n1=n1
  n2=n2
  r=r
  formula=formula
  
default:
  title = "IPolNewton"
  periodicity=0
  method=multipass
  angle=90.0
  

  func pixfu
    caption="Pix-func"
    default=ident()
  endfunc
  
  param formula
    enum="z^n0/(1+z^n1)^n2" "sinh(z/(1+sin(z)))" "ln(z)/(1+sin(z))" "sin(z)/(1+ln(z))"
    default=0
  endparam
  
  param n0
    caption="z^n0"
    default=(2,0)
  endparam

  
  param n1
    caption="1+z^n1"
    default=(-3,0)
  endparam
  
  param n2
    caption="(1+z)^n2"
    default=(3,0)
  endparam
  
  param r
    caption="root"
    default=(1,0)
  endparam
  
  param init
    enum="auto" "z-init" "pixel-init"
    default=0
    hint="z initiates by the actual pixelvalue."
  endparam
  
  param zinit
    caption="z-init"
    default=(1.0,0)
  endparam
  
  param bailout
    caption="bailout"
    default=1E-5
  endparam
}


IPolNewtonJulia {
init:
  complex z=#pixel
  complex zold=0
  complex t=0
  complex u=0
  complex v=0

loop:
  zold=z
  if zold==0
    zold=1e-20
  endif
  if @formula==0
    t=zold^@n1
    u=zold^@n0
    z=zold-(u-@r*(1+t)^@n2)/(u/zold*(@n0-@n2*@n1*t/(1+t)))+@pixfu(@seed)
  elseif @formula==1
    t=zold^@n1
    u=zold^@n0
    v=1+sin(t)
    z=zold-(sinh(u/v^@n2)-@r)/(cosh(u/zold*(@n0-@n2*@n1*zold*cos(t)/v)/v^@n2))+@pixfu(@seed)
  elseif @formula==2
    t=zold^@n1
    u=zold^@n0
    v=log(u)
    z=zold-(v-@r*(1+sin(t))^@n2)/(@n0/zold-(@n1*@n2*t/zold*v*cos(t))/(1+sin(t))^@n2) \
      +@pixfu(@seed)
  elseif @formula==3
    t=zold^@n1
    u=zold^@n0
    v=1+log(t)
    z=zold-(sin(u)-@r*v^@n2)/(@n0*u/zold*cos(u)-(@n1*@n2/zold*sin(u)/v))+@pixfu(@seed)
  endif
bailout:
|z-zold|>@bailout
  
switch:
  type="IPolNewton"
  pixfu=pixfu
  bailout=bailout
  init=init
  zinit=zinit
  n0=n0
  n1=n1
  n2=n2
  r=r
  formula=formula
  
default:
  title = "IPolNewtonJulia"
  periodicity=0
  method=multipass
  angle=90.0
  
  

  func pixfu
    caption="Pix-func"
    default=ident()
  endfunc
  
  param formula
    enum="z^n0/(1+z^n1)^n2" "sinh(z/(1+sin(z)))" "ln(z)/(1+sin(z))" "sin(z)/(1+ln(z))"
    default=0
  endparam
  
  param seed
    caption="Seed"
    default=(0,0)
  endparam
  
  param n0
    caption="z^n0"
    default=(2,0)
  endparam

  
  param n1
    caption="1+z^n1"
    default=(-3,0)
  endparam
  
  param n2
    caption="(1+z)^n2"
    default=(3,0)
  endparam
  
  param r
    caption="root"
    default=(1,0)
  endparam

  param init
    enum="auto" "z-init" "pixel-init"
    default=0
    hint="z initiates by the actual pixelvalue."
  endparam
  
  param zinit
    caption="z-init"
    default=(1.0,0)
  endparam
  
  param bailout
    caption="bailout"
    default=1E-5
  endparam
}



EMandel {
init:
  complex z=@zinit
  complex zold=0
loop:
  zold=z
  z=@fu1(z)^@fu2(z)+@pixfu(#pixel)
bailout:
    (!@newton && (|z|<@bailout))||(@newton && (|z-zold|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="EMandelJulia"
  seed=#pixel
  bailout=bailout
  fu1=fu1
  fu2=fu2
  pixfu=pixfu
  newton=newton
  zinit=zinit
    
  
default:
  title = "EMandel"
  periodicity=0
  method=multipass
  
  func fu1
    caption="func 1"
    default=ident()
  endfunc
  
  func fu2
    caption="func 2"
    default=ident()
  endfunc
  
  func pixfu
    caption="Pixel func"
    default=ident()
  endfunc
  
  param zinit
    caption="z-init"
    default=(0,0)
  endparam
  
  param newton
    caption="Diff bailout"
    default=true
    hint="Difference bailout"
  endparam
  
  param bailout
    caption="bailout"
    default=100.0

  endparam

}



EMandelJulia {
init:
  complex z=#pixel
  complex zold=0
loop:
  zold=z
  z=@fu1(z)^@fu2(z)+@pixfu(@seed)
bailout:
    (!@newton && (|z|<@bailout))||(@newton && (|z-zold|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="EMandel"
  seed=#pixel
  bailout=bailout
  fu1=fu1
  fu2=fu2
  pixfu=pixfu
  newton=newton
  zinit=zinit
  
default:
  title = "EMandelJulia"
  periodicity=0
  method=multipass
  
  func fu1
    caption="func 1"
    default=ident()
  endfunc
  
  func fu2
    caption="func 2"
    default=ident()
  endfunc
  
  func pixfu
    caption="Pixel func"
    default=ident()
  endfunc
  
  param seed
    caption="Seed"
    default=(1.07,-0.34)
  endparam
  
  param newton
    caption="Diff bailout"
    default=true
    hint="Difference bailout"
  endparam
  
  param zinit
    caption="z-init"
    default=(0,0)
  endparam
  
  param bailout
    caption="bailout"
    default=100.0
  endparam
}


QuarticParameterspace {

init:
  int n=0
  int m1save=0
  int m2save=0
  int m3save=0
  float abs1=0
  float abs2=0
  float abs3=0
  complex z=0
  complex oldz=0
  float t=0
  float aa=0

  complex a=0+0i
  complex b=0+0i
  complex c=0+0i
  float cc=real(#pixel)
  float dd=imag(#pixel)
  float IX=0
  float IY=0
  float IU=0
  float IV=0
  float resIX=0
  float resIY=0
  float resIU=0
  float resIV=0
  float yrot=0
  float xrot=0
  float zrot=0
  
  IF @PlottedPlane==0
    IX=@breal
    IY=@bimag
    IU=@creal
    IV=@cimag
  ELSEIF @PlottedPlane==1
    IX=@areal
    IY=@aimag
    IU=@breal
    IV=@bimag
  ELSEIF @PlottedPlane==2
    IX=@aimag
    IY=@bimag
    IU=@creal
    IV=@cimag
  ELSEIF @PlottedPlane==3
    IX=@aimag
    IY=@breal
    IU=@bimag
    IV=@cimag
  ELSEIF @PlottedPlane==4
    IX=@aimag
    IY=@breal
    IU=@creal
    IV=@cimag
  ELSEIF @PlottedPlane==5
    IX=@aimag
    IY=@breal
    IU=@bimag
    IV=@creal
  ELSEIF @PlottedPlane==6
    IX=@areal
    IY=@breal
    IU=@bimag
    IV=@cimag
  ELSEIF @PlottedPlane==7
    IX=@areal
    IY=@breal
    IU=@creal
    IV=@cimag
  ELSE
    IX=@areal
    IY=@breal
    IU=@bimag
    IV=@creal
  ENDIF
    
  IF @LocalRot==true
    cc=cc-real(#center)
    dd=dd-imag(#center)
    resIX=IX
    resIY=IY
    resIU=IU
    resIV=IV
    IX=0
    IY=0
    IU=0
    IV=0
  ENDIF

    IF @yrot!=0
      yrot=(@yrot%360)*pi/180
      t=cabs(cc+IX*1i)      
      aa=atan2(cc+IX*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IX=0
      ELSEIF aa==pi/2
        cc=0
        IX=t
      ELSEIF aa==-pi/2
        cc=0
        IX=-t
      ELSE
        cc=t*cos(aa)
        IX=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrot!=0
      xrot=(@xrot%360)*pi/180
      t=cabs(IX+dd*1i)     
      aa=atan2(IX+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IX=-t
        dd=0
      ELSEIF aa==pi/2
        IX=0
        dd=t
      ELSEIF aa==-pi/2
        IX=0
        dd=-t
      ELSE
        IX=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
      
      
    IF @zrot!=0
      zrot=(@zrot%360)*pi/180
      t=cabs(cc+dd*1i)
      aa=atan2(cc+dd*1i)     
      aa=zrot+aa
      IF abs(aa)==pi
        cc=-t
        dd=0
      ELSEIF aa==pi/2
        cc=0
        dd=t
      ELSEIF aa==-pi/2
        cc=0
        dd=-t
      ELSE
        cc=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
    

    IF @yrott!=0
      yrot=(@yrott%360)*pi/180
      t=cabs(cc+IY*1i)      
      aa=atan2(cc+IY*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IY=0
      ELSEIF aa==pi/2
        cc=0
        IY=t
      ELSEIF aa==-pi/2
        cc=0
        IY=-t
      ELSE
        cc=t*cos(aa)
        IY=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrott!=0
      xrot=(@xrott%360)*pi/180
      t=cabs(IY+dd*1i)     
      aa=atan2(IY+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IY=-t
        dd=0
      ELSEIF aa==pi/2
        IY=0
        dd=t
      ELSEIF aa==-pi/2
        IY=0
        dd=-t
      ELSE
        IY=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
    
    IF @yrotu!=0
      yrot=(@yrotu%360)*pi/180
      t=cabs(cc+IU*1i)      
      aa=atan2(cc+IU*1i)

      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IU=0
      ELSEIF aa==pi/2
        cc=0
        IU=t
      ELSEIF aa==-pi/2
        cc=0
        IU=-t
      ELSE
        cc=t*cos(aa)
        IU=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrotu!=0
      xrot=(@xrotu%360)*pi/180
      t=cabs(IU+dd*1i)     
      aa=atan2(IU+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IU=-t
        dd=0
      ELSEIF aa==pi/2
        IU=0
        dd=t
      ELSEIF aa==-pi/2
        IU=0
        dd=-t
      ELSE
        IU=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
    
    IF @yrotv!=0
      yrot=(@yrotv%360)*pi/180
      t=cabs(cc+IV*1i)      
      aa=atan2(cc+IV*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IV=0
      ELSEIF aa==pi/2
        cc=0
        IV=t
      ELSEIF aa==-pi/2
        cc=0
        IV=-t
      ELSE
        cc=t*cos(aa)
        IV=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrotv!=0
      xrot=(@xrotv%360)*pi/180
      t=cabs(IV+dd*1i)     
      aa=atan2(IV+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IV=-t
        dd=0
      ELSEIF aa==pi/2
        IV=0
        dd=t
      ELSEIF aa==-pi/2
        IV=0
        dd=-t
      ELSE
        IV=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF

  
  IF @LocalRot==true
    cc=cc+real(#center)
    dd=dd+imag(#center)
    IX=IX+resIX
    IY=IY+resIY
    IU=IU+resIU
    IV=IV+resIV
  ENDIF
    
  IF @PlottedPlane==0
    a=cc+dd*1i
    b=IX+IY*1i
    c=IU+IV*1i 
  ELSEIF @PlottedPlane==1
    a=IX+IY*1i
    b=IU+IV*1i
    c=cc+dd*1i
  ELSEIF @PlottedPlane==2
    a=cc+IX*1i
    b=dd+IY*1i
    c=IU+IV*1i
  ELSEIF @PlottedPlane==3
    a=cc+IX*1i

    b=IY+IU*1i
    c=dd+IV*1i
  ELSEIF @PlottedPlane==4
    a=cc+IX*1i
    b=IY+dd*1i
    c=IU+IV*1i
  ELSEIF @PlottedPlane==5
    a=cc+IX*1i
    b=IY+IU*1i
    c=IV+dd*1i
  ELSEIF @PlottedPlane==6
    a=IX+dd*1i
    b=IY+IU*1i
    c=cc+IV*1i
  ELSEIF @PlottedPlane==7
    a=IX+cc*1i
    b=IY+dd*1i
    c=IU+IV*1i
  ELSE
    a=IX+cc*1i
    b=IY+IU*1i
    c=IV+dd*1i
  ENDIF


  if (@M==0)&&(@mode==0)
    z=a
  elseif (@M==1)&&(@mode==0)
    z=b
  elseif (@M==2)&&(@mode==0)
    z=-a-b
  else
    z=a
    while (|z|<@bailout)&&(n<#maxiter)
      n=n+1
      z=z*z*z*z+2*(a*b-(a+b)*(a+b))*z*z+4*a*b*(a+b)*z+c
    endwhile
    m1save=n
    abs1=|z|
    n=0
    z=b
    while (|z|<@bailout)&&(n<#maxiter)
      n=n+1
      z=z*z*z*z+2*(a*b-(a+b)*(a+b))*z*z+4*a*b*(a+b)*z+c
    endwhile
    m2save=n
    abs2=|z|
    n=0
    z=-a-b
    while (|z|<@bailout)&&(n<#maxiter)
      n=n+1
      z=z*z*z*z+2*(a*b-(a+b)*(a+b))*z*z+4*a*b*(a+b)*z+c
    endwhile
    m3save=n
    abs3=|z|
    if @mode==1
      if @M==0
        if m1save==#maxiter
          z=a
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          else
            if m2save>m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=b
          endif
        elseif (m1save<#maxiter)&&(m3save<#maxiter)
          if m1save>m3save
            z=a
          else
            z=-a-b
          endif
        else
          z=a
        endif
      elseif @M==1
        if m2save==#maxiter
          z=b
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save>m2save
            if m1save>m3save
              z=a

            else

              z=-a-b

            endif
          else
            if m2save>m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=b
          endif
        elseif (m2save<#maxiter)&&(m3save<#maxiter)
          if m2save>m3save
            z=b
          else
            z=-a-b
          endif
        else
          z=b
        endif
      elseif @M==2
        if m3save==#maxiter
          z=-a-b
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          else
            if m2save>m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m1save<#maxiter)&&(m3save<#maxiter)
          if m1save>m3save
            z=a
          else
            z=-a-b
          endif
        elseif (m2save<#maxiter)&&(m3save<#maxiter)
          if m2save>m3save
            z=b
          else
            z=-a-b
          endif
        else
          z=-a-b
        endif
      elseif @M==3
        if (m1save==#maxiter)&&(m2save==#maxiter)&&(m3save==#maxiter)
          if abs1>abs2
            if abs1>abs3
              z=a
            else
              z=-a-b
            endif
          elseif abs2>abs3
            z=b
          else
            z=-a-b
          endif
        elseif (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1>abs2
            z=a
          else
            z=b
          endif
        elseif (m1save==#maxiter)&&(m3save==#maxiter)
          if abs1>abs3
            z=a
          else
            z=-a-b
          endif
        elseif (m2save==#maxiter)&&(m3save==#maxiter)
          if abs2>abs3
            z=b
          else
            z=-a-b
          endif
        elseif m1save==#maxiter
          z=a
        elseif m2save==#maxiter
          z=b
        elseif m3save==#maxiter
          z=-a-b
        else
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          elseif m2save>m3save
            z=b
          else
            z=-a-b
          endif
        endif
      elseif (@M==4)
        if (m1save==#maxiter)&&(m2save==#maxiter)&&(m3save==#maxiter)
          if abs1>abs2
            if abs1>abs3
              z=a
            else
              z=-a-b
            endif
          elseif abs2>abs3
            z=b
          else
            z=-a-b
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          else
            if m2save>m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m1save==#maxiter)&&(m2save==#maxiter)
          z=-a-b
        elseif (m1save==#maxiter)&&(m3save==#maxiter)
          z=b
        elseif (m2save==#maxiter)&&(m3save==#maxiter)
          z=a
        elseif m1save==#maxiter
          if m2save>m3save
            z=b
          else
            z=-a-b
          endif
        elseif m2save==#maxiter
          if m1save>m3save
            z=a
          else
            z=-a-b
          endif
        else
          if m1save>m2save
            z=a
          else
            z=b
          endif
        endif
      elseif @M==5
        if (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1>abs2
            z=a
          else
            z=b
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          else
            if m2save>m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=b
          endif
        elseif (m1save==#maxiter)
          z=a
        else
          z=b
        endif
      elseif @M==6
        if (m1save==#maxiter)&&(m3save==#maxiter)
          if abs1>abs3
            z=a
          else
            z=-a-b
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          else
            if m2save>m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m1save<#maxiter)&&(m3save<#maxiter)
          if m1save>m3save
            z=a
          else
            z=-a-b
          endif
        elseif (m1save==#maxiter)
          z=a
        else
          z=-a-b
        endif
      elseif @M==7
        if (m2save==#maxiter)&&(m3save==#maxiter)
          if abs2>abs3
            z=b
          else
            z=-a-b
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          else
            if m2save>m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m2save<#maxiter)&&(m3save<#maxiter)
          if m2save>m3save
            z=b
          else
            z=-a-b
          endif
        elseif (m2save==#maxiter)
          z=b

        else
          z=-a-b
        endif
      endif 
    else
      if @M==3
        if (m1save==#maxiter)&&(m2save==#maxiter)&&(m3save==#maxiter)
          if abs1>abs2
            if abs1>abs3
              z=a
            else
              z=-a-b
            endif
          elseif abs2>abs3
            z=b
          else
            z=-a-b
          endif
        elseif (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1>abs2
            z=a
          else
            z=b
          endif
        elseif (m1save==#maxiter)&&(m3save==#maxiter)
          if abs1>abs3
            z=a
          else
            z=-a-b
          endif
        elseif (m2save==#maxiter)&&(m3save==#maxiter)
          if abs2>abs3
            z=b
          else
            z=-a-b
          endif
        elseif m1save==#maxiter
          z=a
        elseif m2save==#maxiter
          z=b
        elseif m3save==#maxiter
          z=-a-b
        else
          if m1save>m2save
            if m1save>m3save
              z=a
            else
              z=-a-b
            endif
          elseif m2save>m3save
            z=b
          else
            z=-a-b
          endif
        endif
      elseif (@M==4)
        if (m1save==#maxiter)&&(m2save==#maxiter)&&(m3save==#maxiter)
          if abs1<abs2
            if abs1<abs3
              z=a
            else
              z=-a-b
            endif
          elseif abs2<abs3
            z=b
          else
            z=-a-b
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)&&(m3save<#maxiter)
          if m1save<m2save
            if m1save<m3save
              z=a
            else
              z=-a-b
            endif
          else
            if m2save<m3save
              z=b
            else
              z=-a-b
            endif
          endif
        elseif (m1save==#maxiter)&&(m2save==#maxiter)
          z=-a-b
        elseif (m1save==#maxiter)&&(m3save==#maxiter)
          z=b
        elseif (m2save==#maxiter)&&(m3save==#maxiter)
          z=a
        elseif m1save==#maxiter
          if m2save<m3save
            z=b
          else

            z=-a-b
          endif
        elseif m2save==#maxiter
          if m1save<m3save
            z=a
          else
            z=-a-b
          endif
        else
          if m1save<m2save
            z=a
          else
            z=b
          endif
        endif
      elseif @M==5
        if (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1>abs2
            z=a
          else
            z=b
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=b
          endif
        elseif (m1save==#maxiter)
          z=a
        else
          z=b
        endif
      elseif @M==6
        if (m1save==#maxiter)&&(m3save==#maxiter)
          if abs1>abs3
            z=a
          else
            z=-a-b
          endif
        elseif (m1save<#maxiter)&&(m3save<#maxiter)
          if m1save>m3save
            z=a
          else
            z=-a-b
          endif
        elseif (m1save==#maxiter)
          z=a
        else
          z=-a-b
        endif
      elseif @M==7
        if (m2save==#maxiter)&&(m3save==#maxiter)
          if abs2>abs3
            z=b
          else
            z=-a-b
          endif
        elseif (m2save<#maxiter)&&(m3save<#maxiter)
          if m2save>m3save
            z=b
          else
            z=-a-b
          endif
        elseif (m2save==#maxiter)
          z=b
        else
          z=-a-b
        endif
      endif 
    endif                 
  endif
   
loop:
  oldz=z
  z=z*z*z*z+2*(a*b-(a+b)*(a+b))*z*z+4*a*b*(a+b)*z+c

    
bailout:
  (!@diff && (|z|<@bailout))||(@diff && (|z-oldz|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="QuarticJulia"
  seed=#pixel
  PlottedPlane=PlottedPlane
  M=M
  mode=mode
  areal=areal
  aimag=aimag
  breal=breal
  bimag=bimag
  creal=creal
  cimag=cimag
  xrot=xrot
  yrot=yrot
  xrott=xrott
  yrott=yrott
  xrotu=xrotu
  yrotu=yrotu
  xrotv=xrotv
  yrotv=yrotv
  zrot=zrot
  LocalRot=LocalRot
  diff=diff
  bailout=bailout
  

  
default:
  title = "QuarticParameterspace"
  periodicity=0
  method=multipass
  
  
  param PlottedPlane
    enum = "1.(a-real,a-imag)" "2.(c-real,c-imag)" "3.(a-real,b-real)" "4.(a-real,c-real)" \
           "5.(a-real,b-imag)" "6.(a-real,c-imag)" "7.(c-real,a-imag)" "8.(a-imag,b-imag)" \
           "9.(a-imag,c-imag)"
    default=0
    hint="The axis that will be plotted."
  endparam
  
  param M
    enum="M1" "M2" "M3" "M1+M2+M3" "QCL" "M1+M2" "M1+M3" "M2+M3"
    hint="The choosen critical point to initialize z"
    default=0
  endparam 
  
  param mode
    enum="Normal" "High"
    default=0
  endparam
  
  param areal
    caption=" a-real "
    hint="Value for a-real when a-real is constant (not plotted)."
    default=0.0
  endparam
  
  param aimag
    caption=" a-imag "
    hint="Value for a-imag when a-imag is constant (not plotted)."
    default=0.0
  endparam
  
   param breal
    caption=" b-real "
    hint="Value for b-real when b-real is constant (not plotted)."
    default=0.0
  endparam
  
   param bimag
    caption=" b-imag "
    hint="Value for b-imag when b-imag is constant (not plotted)."
    default=0.0
  endparam
  
   param creal
    caption=" c-real "
    hint="Value for c-real when c-real is constant (not plotted)."
    default=0.0
  endparam
  
   param cimag
    caption=" c-imag "
    hint="Value for c-imag when c-imag is constant (not plotted)."
    default=0.0
  endparam
 
 param xrot
    caption="x-rotz"
    hint= "Rotates yz-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrot
    caption="y-rotz"
    hint= "Rotates xz-plane in degrees around the y-axis."
    default=0.0
 endparam
 
 param xrott
    caption="x-rott"
    hint= "Rotates yt-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrott
    caption="y-rott"
    hint= "Rotates xt-plane in degrees around the y-axis."
    default=0.0
 endparam
 
 param xrotu
    caption="x-rotu"
    hint= "Rotates yu-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrotu
    caption="y-rotu"
    hint= "Rotates xu-plane in degrees around the y-axis."
    default=0.0


 endparam
 
 param xrotv
    caption="x-rotv"
    hint= "Rotates yv-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrotv
    caption="y-rotv"
    hint= "Rotates xv-plane in degrees around the y-axis."
    default=0.0
 endparam
  
  param zrot
    caption="z-rot"
    hint= "Rotating xy-plane in degrees around the z-axis."
    default=0.0
  endparam
  
  
  param LocalRot
    caption="Local Rotation"
    hint="Enables Local Rotation."
    default=false
  endparam
  
  
  param diff
    caption="Diff-Bailout"
    default=false
  endparam
  
  param bailout
    caption="bailout"
    hint="Value for bailout"
    default=100.0
  endparam
     
  }
  
  
QuarticJulia {

init:
  complex z=#pixel
  complex oldz=0
  float t=0
  float aa=0
  complex a=0+0i
  complex b=0+0i
  complex c=0+0i
  float cc=real(@seed)
  float dd=imag(@seed)
  float IX=0
  float IY=0
  float IU=0
  float IV=0
  float resIX=0
  float resIY=0
  float resIU=0
  float resIV=0
  float yrot=0
  float xrot=0
  float zrot=0
  
  IF @PlottedPlane==0
    IX=@breal
    IY=@bimag
    IU=@creal
    IV=@cimag
  ELSEIF @PlottedPlane==1
    IX=@areal
    IY=@aimag
    IU=@breal
    IV=@bimag
  ELSEIF @PlottedPlane==2
    IX=@aimag
    IY=@bimag
    IU=@creal
    IV=@cimag
  ELSEIF @PlottedPlane==3
    IX=@aimag
    IY=@breal
    IU=@bimag
    IV=@cimag
  ELSEIF @PlottedPlane==4
    IX=@aimag
    IY=@breal
    IU=@creal
    IV=@cimag
  ELSEIF @PlottedPlane==5
    IX=@aimag
    IY=@breal
    IU=@bimag
    IV=@creal
  ELSEIF @PlottedPlane==6
    IX=@areal
    IY=@breal

    IU=@bimag
    IV=@cimag
  ELSEIF @PlottedPlane==7
    IX=@areal
    IY=@breal
    IU=@creal

    IV=@cimag
  ELSE
    IX=@areal
    IY=@breal
    IU=@bimag
    IV=@creal
  ENDIF
    
  IF @LocalRot==true
    cc=cc-real(#center)
    dd=dd-imag(#center)
    resIX=IX
    resIY=IY
    resIU=IU
    resIV=IV
    IX=0
    IY=0
    IU=0
    IV=0
  ENDIF

    IF @yrot!=0
      yrot=(@yrot%360)*pi/180
      t=cabs(cc+IX*1i)      
      aa=atan2(cc+IX*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IX=0
      ELSEIF aa==pi/2
        cc=0
        IX=t
      ELSEIF aa==-pi/2
        cc=0
        IX=-t
      ELSE
        cc=t*cos(aa)
        IX=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrot!=0
      xrot=(@xrot%360)*pi/180
      t=cabs(IX+dd*1i)     
      aa=atan2(IX+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IX=-t
        dd=0
      ELSEIF aa==pi/2
        IX=0
        dd=t
      ELSEIF aa==-pi/2
        IX=0
        dd=-t
      ELSE
        IX=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
      
      
    IF @zrot!=0
      zrot=(@zrot%360)*pi/180
      t=cabs(cc+dd*1i)
      aa=atan2(cc+dd*1i)     
      aa=zrot+aa
      IF abs(aa)==pi
        cc=-t
        dd=0
      ELSEIF aa==pi/2
        cc=0

        dd=t
      ELSEIF aa==-pi/2
        cc=0
        dd=-t
      ELSE
        cc=t*cos(aa)
        dd=t*sin(aa)

      ENDIF
    ENDIF
    

    IF @yrott!=0
      yrot=(@yrott%360)*pi/180
      t=cabs(cc+IY*1i)      
      aa=atan2(cc+IY*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IY=0
      ELSEIF aa==pi/2
        cc=0
        IY=t
      ELSEIF aa==-pi/2
        cc=0
        IY=-t
      ELSE
        cc=t*cos(aa)
        IY=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrott!=0
      xrot=(@xrott%360)*pi/180
      t=cabs(IY+dd*1i)     
      aa=atan2(IY+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IY=-t
        dd=0
      ELSEIF aa==pi/2
        IY=0
        dd=t
      ELSEIF aa==-pi/2
        IY=0
        dd=-t
      ELSE
        IY=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
    
    IF @yrotu!=0
      yrot=(@yrotu%360)*pi/180
      t=cabs(cc+IU*1i)      
      aa=atan2(cc+IU*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IU=0
      ELSEIF aa==pi/2
        cc=0
        IU=t
      ELSEIF aa==-pi/2
        cc=0
        IU=-t
      ELSE
        cc=t*cos(aa)
        IU=t*sin(aa)
      ENDIF

    ENDIF
      
    IF @xrotu!=0
      xrot=(@xrotu%360)*pi/180
      t=cabs(IU+dd*1i)     
      aa=atan2(IU+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IU=-t
        dd=0
      ELSEIF aa==pi/2
        IU=0
        dd=t
      ELSEIF aa==-pi/2
        IU=0
        dd=-t
      ELSE
        IU=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
    
    IF @yrotv!=0
      yrot=(@yrotv%360)*pi/180
      t=cabs(cc+IV*1i)      
      aa=atan2(cc+IV*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IV=0
      ELSEIF aa==pi/2
        cc=0
        IV=t
      ELSEIF aa==-pi/2
        cc=0
        IV=-t
      ELSE
        cc=t*cos(aa)

        IV=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrotv!=0
      xrot=(@xrotv%360)*pi/180
      t=cabs(IV+dd*1i)     
      aa=atan2(IV+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IV=-t
        dd=0
      ELSEIF aa==pi/2
        IV=0
        dd=t
      ELSEIF aa==-pi/2
        IV=0
        dd=-t
      ELSE
        IV=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF

  
  IF @LocalRot==true
    cc=cc+real(#center)
    dd=dd+imag(#center)
    IX=IX+resIX
    IY=IY+resIY
    IU=IU+resIU
    IV=IV+resIV
  ENDIF
    
  IF @PlottedPlane==0
    a=cc+dd*1i
    b=IX+IY*1i
    c=IU+IV*1i 
  ELSEIF @PlottedPlane==1
    a=IX+IY*1i
    b=IU+IV*1i

    c=cc+dd*1i
  ELSEIF @PlottedPlane==2
    a=cc+IX*1i
    b=dd+IY*1i
    c=IU+IV*1i
  ELSEIF @PlottedPlane==3
    a=cc+IX*1i
    b=IY+IU*1i
    c=dd+IV*1i
  ELSEIF @PlottedPlane==4
    a=cc+IX*1i
    b=IY+dd*1i

    c=IU+IV*1i
  ELSEIF @PlottedPlane==5
    a=cc+IX*1i
    b=IY+IU*1i
    c=IV+dd*1i
  ELSEIF @PlottedPlane==6
    a=IX+dd*1i
    b=IY+IU*1i
    c=cc+IV*1i
  ELSEIF @PlottedPlane==7
    a=IX+cc*1i
    b=IY+dd*1i
    c=IU+IV*1i
  ELSE
    a=IX+cc*1i
    b=IY+IU*1i
    c=IV+dd*1i
  ENDIF


    
loop:
  oldz=z
  z=z*z*z*z+2*(a*b-(a+b)*(a+b))*z*z+4*a*b*(a+b)*z+c
    
bailout:
  (!@diff && (|z|<@bailout))||(@diff && (|z-oldz|>1/@bailout)&&(|z|<@bailout))

  
switch:
  type="QuarticParameterspace"
  PlottedPlane=PlottedPlane
  M=M
  mode=mode
  areal=areal
  aimag=aimag
  breal=breal
  bimag=bimag
  creal=creal
  cimag=cimag
  xrot=xrot
  yrot=yrot
  xrott=xrott
  yrott=yrott
  xrotu=xrotu
  yrotu=yrotu
  xrotv=xrotv
  yrotv=yrotv
  zrot=zrot
  LocalRot=LocalRot
  diff=diff
  bailout=bailout
  

  
default:
  title = "QuarticJulia"
  periodicity=0
  method=multipass
  
  
  param PlottedPlane
    enum = "1.(a-real,a-imag)" "2.(c-real,c-imag)" "3.(a-real,b-real)" "4.(a-real,c-real)" \
           "5.(a-real,b-imag)" "6.(a-real,c-imag)" "7.(c-real,a-imag)" "8.(a-imag,b-imag)" \
           "9.(a-imag,c-imag)"
    default=0
    hint="The axis that will be plotted."
  endparam
  
  param M
    enum="M1" "M2" "M3" "M1+M2+M3" "QCL" "M1+M2" "M1+M3" "M2+M3"
    hint="The choosen critical point to initialize z"
    default=0
  endparam 
  
  param seed
    caption="seed"
    default=(0,0)

  endparam
  
  param areal

    caption=" a-real "
    hint="Value for a-real when a-real is constant (not plotted)."
    default=0.0
  endparam
  
  param aimag
    caption=" a-imag "
    hint="Value for a-imag when a-imag is constant (not plotted)."
    default=0.0
  endparam
  
   param breal
    caption=" b-real "
    hint="Value for b-real when b-real is constant (not plotted)."
    default=0.0
  endparam
  
   param bimag
    caption=" b-imag "
    hint="Value for b-imag when b-imag is constant (not plotted)."
    default=0.0
  endparam
  
   param creal
    caption=" c-real "
    hint="Value for c-real when c-real is constant (not plotted)."
    default=0.0
  endparam
  
   param cimag
    caption=" c-imag "
    hint="Value for c-imag when c-imag is constant (not plotted)."
    default=0.0

  endparam
 
 param xrot
    caption="x-rotz"
    hint= "Rotates yz-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrot
    caption="y-rotz"
    hint= "Rotates xz-plane in degrees around the y-axis."
    default=0.0
 endparam
 
 param xrott
    caption="x-rott"
    hint= "Rotates yt-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrott
    caption="y-rott"
    hint= "Rotates xt-plane in degrees around the y-axis."
    default=0.0
 endparam
 
 param xrotu
    caption="x-rotu"
    hint= "Rotates yu-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrotu
    caption="y-rotu"
    hint= "Rotates xu-plane in degrees around the y-axis."
    default=0.0
 endparam
 
 param xrotv
    caption="x-rotv"
    hint= "Rotates yv-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrotv
    caption="y-rotv"
    hint= "Rotates xv-plane in degrees around the y-axis."
    default=0.0
 endparam
  
  param zrot
    caption="z-rot"
    hint= "Rotating xy-plane in degrees around the z-axis."
    default=0.0
  endparam
  
  
  param LocalRot
    caption="Local Rotation"
    hint="Enables Local Rotation."
    default=false
  endparam
  
  
  param diff
    caption="Diff-Bailout"
    default=false
  endparam
  
  param bailout
    caption="bailout"
    hint="Value for bailout"
    default=100.0
  endparam
     
  }
  
  
CubicParameterspace2 {

init:
  int n=0
  int m1save=0
  int m2save=0
  float abs1=0
  float abs2=0
  complex z=0
  complex oldz=0
  float t=0
  float aa=0
  complex a=0+0i
  complex b=0+0i
  float cc=real(#pixel)
  float dd=imag(#pixel)
  float IX=0
  float IY=0
  float resIX=0
  float resIY=0
  float yrot=0
  float xrot=0
  float zrot=0
  
  IF @PlottedPlane==0     ;a-real, a-imag
    IX=@breal
    IY=@bimag
  ELSEIF @PlottedPlane==1 ;a-real, b-real
    IX=@aimag
    IY=@bimag
  ELSEIF @PlottedPlane==2 ;a-real, b-imag
    IX=@aimag
    IY=@breal
  ELSEIF @PlottedPlane==3 ;a-imag, b-real
    IX=@areal
    IY=@bimag
  ELSEIF @PlottedPlane==4 ;a-imag, b-imag
    IX=@areal
    IY=@breal
  ELSE                    ;b-real, b-imag
    IX=@areal
    IY=@aimag
  ENDIF
    
  IF @LocalRot==true
    cc=cc-real(#center)
    dd=dd-imag(#center)
    resIX=IX
    resIY=IY
    IX=0
    IY=0
  ENDIF

    IF @yrot!=0  ;yrot-z
      yrot=(@yrot%360)*pi/180
      t=cabs(cc+IX*1i)      
      aa=atan2(cc+IX*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IX=0
      ELSEIF aa==pi/2
        cc=0
        IX=t
      ELSEIF aa==-pi/2
        cc=0
        IX=-t
      ELSE
        cc=t*cos(aa)
        IX=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrot!=0   ;xrot-z
      xrot=(@xrot%360)*pi/180
      t=cabs(IX+dd*1i)     
      aa=atan2(IX+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IX=-t
        dd=0
      ELSEIF aa==pi/2
        IX=0
        dd=t
      ELSEIF aa==-pi/2
        IX=0
        dd=-t
      ELSE
        IX=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @zrot!=0   ;zrot-xy
      zrot=(@zrot%360)*pi/180
      t=cabs(cc+dd*1i)
      aa=atan2(cc+dd*1i)     
      aa=zrot+aa
      IF abs(aa)==pi
        cc=-t
        dd=0
      ELSEIF aa==pi/2
        cc=0
        dd=t
      ELSEIF aa==-pi/2
        cc=0
        dd=-t
      ELSE
        cc=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
      

    IF @yrott!=0   ;yrot-t
      yrot=(@yrott%360)*pi/180
      t=cabs(cc+IY*1i)      
      aa=atan2(cc+IY*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IY=0
      ELSEIF aa==pi/2
        cc=0
        IY=t
      ELSEIF aa==-pi/2
        cc=0
        IY=-t

      ELSE
        cc=t*cos(aa)
        IY=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrott!=0   ;xrot-t
      xrot=(@xrott%360)*pi/180
      t=cabs(IY+dd*1i)     
      aa=atan2(IY+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IY=-t
        dd=0
      ELSEIF aa==pi/2
        IY=0
        dd=t
      ELSEIF aa==-pi/2
        IY=0
        dd=-t
      ELSE
        IY=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
    
    
  IF @LocalRot==true
    cc=cc+real(#center)
    dd=dd+imag(#center)
    IX=IX+resIX
    IY=IY+resIY
  ENDIF
  
  IF @PlottedPlane==0      ;a-real, a-imag
    a=cc+dd*1i
    b=IX+IY*1i
  ELSEIF @PlottedPlane==1  ;a-real, b-real
    a=cc+IX*1i
    b=dd+IY*1i
  ELSEIF @PlottedPlane==2  ;a-real, b-imag
    a=cc+IX*1i
    b=IY+dd*1i
  ELSEIF @PlottedPlane==3  ;a-imag, b-real
    a=IX+cc*1i
    b=dd+IY*1i
  ELSEIF @PlottedPlane==4  ;a-imag, b-imag
    a=IX+cc*1i
    b=IY+dd*1i
  ELSE
    a=IX+IY*1i             ;b-real, b-imag
    b=cc+dd*1i
  ENDIF


  if (@M==0)&&(@mode==0)
    z=a
  elseif (@M==1)&&(@mode==0)
    z=-a
  else
    z=a
    while (|z|<@bailout)&&(n<#maxiter)
      n=n+1
      z=z*z*z-3*a*a*z+b
    endwhile
    m1save=n
    abs1=|z|
    n=0
    z=-a
    while (|z|<@bailout)&&(n<#maxiter)
      n=n+1
      z=z*z*z-3*a*a*z+b
    endwhile
    m2save=n
    abs2=|z|

    if @mode==1
      if @M==0  ;M1
        if m1save==#maxiter
          z=a
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=-a
          endif
        else
          z=a
        endif
        
      elseif @M==1  ;M2
        if m2save==#maxiter
          z=-a
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=-a
          endif
        else 
          z=-a
        endif
        
      elseif (@M==2)
        if (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1>abs2
            z=a
          else
            z=-a
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=-a
          endif
        elseif m1save==#maxiter
          z=-a
        elseif m2save==#maxiter
          z=a
        else
          if m1save>m2save
            z=a
          else
            z=-a
          endif
        endif       
      elseif @M==3
        if (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1>abs2
            z=a
          else
            z=-a
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else
            z=-a
          endif
        elseif (m1save==#maxiter)
          z=a
        else
          z=-a
        endif
      endif     
    else
      if (@M==2)
        if (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1<abs2
            z=a
          else
            z=-a
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save<m2save
            z=a
          else
            z=-a
          endif
        elseif m1save==#maxiter
          z=-a
        elseif m2save==#maxiter
          z=a
        else
          if m1save<m2save
            z=a
          else
            z=-a
          endif
        endif
      elseif @M==3
        if (m1save==#maxiter)&&(m2save==#maxiter)
          if abs1>abs2
            z=a
          else
            z=-a
          endif
        elseif (m1save<#maxiter)&&(m2save<#maxiter)
          if m1save>m2save
            z=a
          else

            z=-a
          endif
        elseif (m1save==#maxiter)
          z=a
        else
          z=-a
        endif
      endif
    endif                 
  endif
   
loop:
  oldz=z
  z=z*z*z-3*a*a*z+b

    
bailout:
  (!@diff && (|z|<@bailout))||(@diff && (|z-oldz|>1/@bailout)&&(|z|<@bailout))

  
switch:
  type="CubicJulia2"
  seed=#pixel
  PlottedPlane=PlottedPlane
  M=M
  mode=mode
  areal=areal
  aimag=aimag
  breal=breal
  bimag=bimag
  xrot=xrot
  yrot=yrot
  xrott=xrott
  yrott=yrott
  zrot=zrot
  LocalRot=LocalRot
  diff=diff

  bailout=bailout
  

  
default:
  title = "CubicParameterspace2"
  periodicity=0
  method=multipass
  
  
  param PlottedPlane
    enum = "1.(a-real,a-imag)" "2.(a-real,b-real)" "3.(a-real,b-imag)" "4.(a-imag,b-real)"   \
           "5.(a-imag,b-imag)" "6.(b-real,b-imag)"
    default=0
    hint="The axis that will be plotted."
  endparam
  
  param M
    enum="M+" "M-" "CCL" "M+ and/or M-"
    hint="The choosen critical point to initialize z"
    default=0
  endparam 
  
  param mode
    enum="Normal" "High"
    default=0
  endparam
  
  param areal
    caption=" a-real "
    hint="Value for a-real when a-real is constant (not plotted)."
    default=0.0
  endparam
  
  param aimag
    caption=" a-imag "
    hint="Value for a-imag when a-imag is constant (not plotted)."
    default=0.0
  endparam
  
   param breal
    caption=" b-real "
    hint="Value for b-real when b-real is constant (not plotted)."
    default=0.0
  endparam
  
   param bimag
    caption=" b-imag "
    hint="Value for b-imag when b-imag is constant (not plotted)."
    default=0.0
  endparam
  
 
 param xrot
    caption="x-rotz"
    hint= "Rotates yz-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrot
    caption="y-rotz"
    hint= "Rotates xz-plane in degrees around the y-axis."
    default=0.0
 endparam
 
 param xrott
    caption="x-rott"
    hint= "Rotates yt-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrott
    caption="y-rott"
    hint= "Rotates xt-plane in degrees around the y-axis."
    default=0.0
 endparam
 
  
  param zrot
    caption="z-rot"
    hint= "Rotating xy-plane in degrees around the z-axis."
    default=0.0
  endparam


  
  param LocalRot
    caption="Local Rotation"
    hint="Enables Local Rotation."
    default=false
  endparam
  
  
  param diff
    caption="Diff-Bailout"
    default=false
  endparam
  
  param bailout
    caption="bailout"
    hint="Value for bailout"
    default=100.0
  endparam
     
  }
  
  
CubicJulia2 {

init:
  complex z=#pixel
  complex oldz=0+0i
  float t=0
  float aa=0
  complex a=0+0i
  complex b=0+0i
  float cc=real(@seed)
  float dd=imag(@seed)
  float IX=0
  float IY=0
  float resIX=0
  float resIY=0
  float yrot=0
  float xrot=0
  float zrot=0
  
  IF @PlottedPlane==0     ;a-real, a-imag
    IX=@breal
    IY=@bimag
  ELSEIF @PlottedPlane==1 ;a-real, b-real
    IX=@aimag
    IY=@bimag
  ELSEIF @PlottedPlane==2 ;a-real, b-imag
    IX=@aimag
    IY=@breal
  ELSEIF @PlottedPlane==3 ;a-imag, b-real
    IX=@areal
    IY=@bimag
  ELSEIF @PlottedPlane==4 ;a-imag, b-imag
    IX=@areal
    IY=@breal
  ELSE                    ;b-real, b-imag
    IX=@areal
    IY=@aimag
  ENDIF
  
  IF @LocalRot==true
    cc=cc-real(#center)
    dd=dd-imag(#center)
    resIX=IX
    resIY=IY
    IX=0
    IY=0
  ENDIF

    IF @yrot!=0  ;yrot-z

      yrot=(@yrot%360)*pi/180
      t=cabs(cc+IX*1i)      
      aa=atan2(cc+IX*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IX=0
      ELSEIF aa==pi/2
        cc=0
        IX=t
      ELSEIF aa==-pi/2
        cc=0
        IX=-t
      ELSE
        cc=t*cos(aa)
        IX=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrot!=0   ;xrot-z
      xrot=(@xrot%360)*pi/180
      t=cabs(IX+dd*1i)     
      aa=atan2(IX+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IX=-t
        dd=0
      ELSEIF aa==pi/2
        IX=0
        dd=t
      ELSEIF aa==-pi/2

        IX=0
        dd=-t
      ELSE
        IX=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @zrot!=0   ;zrot-xy
      zrot=(@zrot%360)*pi/180
      t=cabs(cc+dd*1i)
      aa=atan2(cc+dd*1i)     
      aa=zrot+aa
      IF abs(aa)==pi
        cc=-t
        dd=0
      ELSEIF aa==pi/2
        cc=0
        dd=t
      ELSEIF aa==-pi/2
        cc=0
        dd=-t
      ELSE
        cc=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
      

    IF @yrott!=0   ;yrot-t
      yrot=(@yrott%360)*pi/180
      t=cabs(cc+IY*1i)      
      aa=atan2(cc+IY*1i)
      aa=yrot+aa
      IF abs(aa)==pi
        cc=-t
        IY=0
      ELSEIF aa==pi/2
        cc=0
        IY=t
      ELSEIF aa==-pi/2
        cc=0
        IY=-t
      ELSE
        cc=t*cos(aa)
        IY=t*sin(aa)
      ENDIF
    ENDIF
      
    IF @xrott!=0   ;xrot-t
      xrot=(@xrott%360)*pi/180
      t=cabs(IY+dd*1i)     
      aa=atan2(IY+dd*1i)
      aa=xrot+aa
      IF abs(aa)==pi
        IY=-t
        dd=0
      ELSEIF aa==pi/2
        IY=0
        dd=t
      ELSEIF aa==-pi/2
        IY=0
        dd=-t
      ELSE
        IY=t*cos(aa)
        dd=t*sin(aa)
      ENDIF
    ENDIF
    
  IF @LocalRot==true
    cc=cc+real(#center)
    dd=dd+imag(#center)
    IX=IX+resIX
    IY=IY+resIY
  ENDIF
    
  
  IF @PlottedPlane==0      ;a-real, a-imag
    a=cc+dd*1i
    b=IX+IY*1i
  ELSEIF @PlottedPlane==1  ;a-real, b-real
    a=cc+IX*1i
    b=dd+IY*1i
  ELSEIF @PlottedPlane==2  ;a-real, b-imag
    a=cc+IX*1i
    b=IY+dd*1i
  ELSEIF @PlottedPlane==3  ;a-imag, b-real
    a=IX+cc*1i
    b=dd+IY*1i
  ELSEIF @PlottedPlane==4  ;a-imag, b-imag
    a=IX+cc*1i
    b=IY+dd*1i
  ELSE
    a=IX+IY*1i             ;b-real, b-imag
    b=cc+dd*1i
  ENDIF

    
  
loop:
  oldz=z
  z=z*z*z-3*a*a*z+b

    
bailout:
  (!@diff && (|z|<@bailout))||(@diff && (|z-oldz|>1/@bailout)&&(|z|<@bailout))
  
switch:
  type="CubicParameterspace2"
  PlottedPlane=PlottedPlane
  M=M
  mode=mode
  areal=areal
  aimag=aimag
  breal=breal
  bimag=bimag
  xrot=xrot
  yrot=yrot
  xrott=xrott
  yrott=yrott
  zrot=zrot
  LocalRot=LocalRot
  diff=diff

  bailout=bailout
  


  
default:
  title = "CubicJulia2"
  periodicity=0
  method=multipass
  
  

  
  param PlottedPlane
    enum = "1.(a-real,a-imag)" "2.(a-real,b-real)" "3.(a-real,b-imag)" "4.(a-imag,b-real)"   \
           "5.(a-imag,b-imag)" "6.(b-real,b-imag)"
    default=0
    hint="The axis that will be plotted."
  endparam
  
  param M
    enum="M+" "M-" "CCL" "M+ and/or M-"
    hint="The choosen critical point to initialize z"
    default=0
  endparam 
  
  param mode

    enum="Normal" "High"
    default=0
  endparam
  
  param areal
    caption=" a-real "
    hint="Value for a-real when a-real is constant (not plotted)."
    default=0.0
  endparam
  
  param aimag
    caption=" a-imag "
    hint="Value for a-imag when a-imag is constant (not plotted)."
    default=0.0
  endparam
  
   param breal
    caption=" b-real "
    hint="Value for b-real when b-real is constant (not plotted)."
    default=0.0
  endparam
  
   param bimag
    caption=" b-imag "
    hint="Value for b-imag when b-imag is constant (not plotted)."
    default=0.0
  endparam
  
 
 param xrot
    caption="x-rotz"
    hint= "Rotates yz-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrot
    caption="y-rotz"
    hint= "Rotates xz-plane in degrees around the y-axis."
    default=0.0
 endparam
 
 param xrott
    caption="x-rott"
    hint= "Rotates yt-plane in degrees around the x-axes."
    default=0.0
 endparam
  
 param yrott
    caption="y-rott"

    hint= "Rotates xt-plane in degrees around the y-axis."
    default=0.0
 endparam
 
  
  param zrot
    caption="z-rot"
    hint= "Rotating xy-plane in degrees around the z-axis."
    default=0.0
  endparam
  
 

   param LocalRot
    caption="Local Rotation"
    hint="Enables Local Rotation."
    default=false
  endparam
  
  
  param diff
    caption="Diff-Bailout"
    default=false
  endparam
  
  param bailout
    caption="bailout"
    hint="Value for bailout"
    default=100.0
  endparam
  
  
  param seed
    caption="Seed"
    default=(0,0)
    hint="Seed for Julia"
  endparam
     
  }



  


  


